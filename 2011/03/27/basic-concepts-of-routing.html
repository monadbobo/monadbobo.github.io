<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>路由的基本概念介绍 | pagefault</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">路由的基本概念介绍</h1><a id="logo" href="/.">pagefault</a><p class="description">但行好事 莫問前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">路由的基本概念介绍</h1><div class="post-meta">Mar 27, 2011<span> | </span><span class="category"><a href="/categories/kernel/">kernel</a><a href="/categories/kernel/协议/">协议</a></span></div><div class="post-content"><p>这里主要是针对linux下的路由一些基本概念.</p>
<p>1 路由是位于L3（ip层）。</p>
<p>2 路由表(routing table)也叫做Forwarding Information Base(FIB).</p>
<p>3 路由器之间通过路由协议(routing protocols)进行信息的交换.</p>
<p>4 一个路由表包含了一大堆的路由，一个路由就是存储了一些传输数据包到给定地址的必须信息。在linux里面一个路由主要包括了这三个参数，分别是目的网络地址，需要使用的设备以及下一跳网关(next hop gateway)。</p>
<a id="more"></a>
<p>5 路由器一般会被设置成下面三种情况。</p>
<p>a 不同的网段对应路由器不同的网络接口</p>
<p>b 路由器在同一个lan有2个网络接口，这两个网络接口被配置成不同的子网.</p>
<p>6 对称路由(symmetric route)和不对称路由(asymmetric route),其中对称路由指的是从HOST a到HOST b所走的路由和从HOST b到HOST a所走的路由是相同的，而不对称则刚好相反。</p>
<p>7 metric是一个可选的，能够配置到一个路由选项的参数。这里注意，这个metric和路由协议中的metric是完全不同的。具体是起什么作用，还没太搞懂。</p>
<p>8 scope，ip地址和路由都有一个域的概念，主要是告诉内核他们起作用的上下文。在linux中，路由的域表明了目的网络和本机的距离。而ip地址的域说明了这个ip地址的作用域。在linux中一共有3种作用域，分别是HOST，LINK(对于ip地址来说说明这个地址是只在lan中使用，而对于route来说目的的地址在lan中),Universe/global(广域网的地址,对于route来说要到达这个地址肯定会多于1跳).</p>
<p>要注意，域的默认值是Universe，也就是说你不显示指明，则默认都是Universe，下面就是我的电脑里面的路由和ip的一些信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">[diaoliang@T-diaoliang project]$ ip route list</span><br><span class="line">  </span><br><span class="line">10.13.116.64/26 dev eth0 proto kernel scope link src 10.13.116.71 metric 1</span><br><span class="line">  </span><br><span class="line">//默认路由都是Universe,via表示下一跳的网关地址。</span><br><span class="line">  </span><br><span class="line">default via 10.13.116.126 dev eth0 proto static</span><br><span class="line">  </span><br><span class="line">[diaoliang@T-diaoliang project]$ ip address</span><br><span class="line">  </span><br><span class="line">1: lo: &amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">inet 127.0.0.1/8 scope host lo</span><br><span class="line">      </span><br><span class="line">inet6 ::1/128 scope host</span><br><span class="line">         </span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">  </span><br><span class="line">2: eth0: &amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">inet 10.13.116.71/26 brd 10.13.116.127 scope global eth0</span><br><span class="line">      </span><br><span class="line">inet6 fe80::225:64ff:fec1:d586/64 scope link</span><br><span class="line">         </span><br><span class="line">valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>9 在一个网卡配多个网络地址，以前(使用ifconfig)需要设置虚拟设备(eth0:0, eth0:1).而现在则(IPROUTE)直接用ip address来添加地址就可以了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">[diaoliang@T-diaoliang ~]$ sudo ip address add 10.13.116.67/26 dev lo</span><br><span class="line">   </span><br><span class="line">ip address</span><br><span class="line">  </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN</span><br><span class="line">      </span><br><span class="line">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">      </span><br><span class="line">inet 127.0.0.1/8 scope host lo</span><br><span class="line">      </span><br><span class="line">inet 10.13.116.67/26 scope global lo</span><br><span class="line">      </span><br><span class="line">inet6 ::1/128 scope host</span><br><span class="line">         </span><br><span class="line">valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>10 linux默认使用两个路由表，一个是针对本地的地址.一个是针对非本地的地址。</p>
<p>11 action，当从路由表得到得到对应的路由(下一跳和输入设备)之后，默认就是forward这个数据包根据返回的路由信息。但是linux提供了一个可选的action选项，这个选项可以在用ip 设置的时候指定。一共分为4种类型，分别是:</p>
<p>a Black hole,匹配这个类型，则数据包会被丢掉。</p>
<p>b Unreachable，匹配这个类型，则数据包被丢掉并且生成一个ICMP的unreachable的消息。</p>
<p>c Prohibit ,匹配这个类型，则数据包也会被丢掉，并且生成一个ICMP的filterd的消息。</p>
<p>d Throw， 这个类型被policy routing使用.</p>
<p>12 路由cache， 路由cache将会被remove， 而multipath cached routing已经被remove掉了。</p>
<p><a href="http://git.kernel.org/?p=linux/kernel/git/davem/net-next-2.6.git;a=commitdiff;h=e06e7c615877026544ad7f8b309d1a3706410383" target="_blank" rel="noopener">http://git.kernel.org/?p=linux/kernel/git/davem/net-next-2.6.git;a=commitdiff;h=e06e7c615877026544ad7f8b309d1a3706410383</a></p>
<p><a href="http://comments.gmane.org/gmane.linux.network/185987" target="_blank" rel="noopener">http://comments.gmane.org/gmane.linux.network/185987</a></p>
<p>13 路由查找，步骤是这样子的。</p>
<p>a 首先在cache查找，如果找到则route 这个包到下一跳。</p>
<p>b 然后在本地地址查找(本地地址的路由表).如果找到则route 这个包</p>
<p>c 然后在非本地的路由表里面查找。</p>
<p>d 如果都没找到，则丢掉这个数据包.</p>
<p>最简单的情况，对于一个目的地址，只会匹配一个路由。复杂的时候，一个目的地址会返回多个路由，这个时候，内核会首先选择LPM算法(Longest Prefix Match), 接下来解释一下LPM。</p>
<p>假设我们有一个目的地址是10.0.0.100，然后匹配了2个路由，分别是10.0.0.0/16和10.0.0.0/24,这个时候由于第二个是24位，所以将会选择第二个路由。</p>
<p>还有一种更复杂的情况，那就是匹配的路由的prefix长度是相同的，还是上面的例子，如果返回两个路由，都是10.0.0.0/24,只不过下一跳的地址不同。所以，内核在使用LPM的同时，还使用了TOS（Type of service)作为一个key。而当tos都相同的时候，内核将会选择更高优先级的路由，如果优先级也相同，内核将会按照顺序选择第一个路由。</p>
<p>14 multipath routing, 对于一个路由，提供多个下一跳，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">ip route add default scope globale nexthop via 100.100.100.1 weight 1 nexthop via 200.200.200.1 weight 2</span><br></pre></td></tr></table></figure>
<p>可以看到加了两个下一跳，然后每一个都有一个权重(weight),而最终选择那个nexthop，主要是根据权重值.内核使用的算法并不是简单的大小比较，它使用了一个随机的算法来选择nexthop(类似round-robin).</p>
<p>15 插入路由信息到内核，使用3种方法。</p>
<p>a 静态的config(ip route/ route).</p>
<p>b 使用一些路由协议(BGP/EGP/OSPF) 来进行动态的config。</p>
<p>c 内核收到ICMP redirect 消息。</p>
<p>b方法中，会在用户空间运行一个daemon进程，这个进程主要是实现了很多路由协议，然后根据协议之间的交互信息，来修改内核中的路由表。比如有Routed,GateD,BIRD.</p>
</div><div class="tags"><a href="/tags/kernel/">kernel</a><a href="/tags/linux/">linux</a><a href="/tags/协议/">协议</a><a href="/tags/路由/">路由</a></div><div class="post-nav"><a class="pre" href="/2011/04/08/design-and-implementation-of-upstream-in-nginx-(1).html">nginx中upstream的设计和实现(一)</a><a class="next" href="/2011/03/13/design-and-implementation-of-if-command-in-nginx.html">nginx中if命令的设计和实现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/">SPDY</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/协议/">协议</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/server/">server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/lua/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/">server</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/源码阅读/">源码阅读</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/语言规范/">语言规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/rocksdb/" style="font-size: 15px;">rocksdb</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/server/" style="font-size: 15px;">server</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/aio/" style="font-size: 15px;">aio</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/process/" style="font-size: 15px;">process</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a> <a href="/tags/google/" style="font-size: 15px;">google</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/路由/" style="font-size: 15px;">路由</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TFO/" style="font-size: 15px;">TFO</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/语言规范/" style="font-size: 15px;">语言规范</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/spdy/" style="font-size: 15px;">spdy</a> <a href="/tags/kenel/" style="font-size: 15px;">kenel</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/InnoDB/" style="font-size: 15px;">InnoDB</a> <a href="/tags/sever/" style="font-size: 15px;">sever</a> <a href="/tags/rfs/" style="font-size: 15px;">rfs</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/congest/" style="font-size: 15px;">congest</a> <a href="/tags/server，mm/" style="font-size: 15px;">server，mm</a> <a href="/tags/web-server/" style="font-size: 15px;">web server</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/pipeline/" style="font-size: 15px;">pipeline</a> <a href="/tags/tcp-cork/" style="font-size: 15px;">tcp_cork</a> <a href="/tags/服务器设计/" style="font-size: 15px;">服务器设计</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/mochiweb/" style="font-size: 15px;">mochiweb</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/loadbalance/" style="font-size: 15px;">loadbalance</a> <a href="/tags/glibc/" style="font-size: 15px;">glibc</a> <a href="/tags/systemcall/" style="font-size: 15px;">systemcall</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/gro/" style="font-size: 15px;">gro</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/design-and-implementation-of-mtr-(mini-transaction).html">MTR(mini-transaction)设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/design-and-implementation-of-linkbuf-in-innodb.html">InnoDB中LinkBuf设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/innodb-tablespace-source-code-analysis.html">InnoDB tablespace源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/mysql-rocksdb.-data-reading-(ii).html">MySQL · RocksDB · 数据的读取(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/mysql-rocksdb.-data-reading-(i).html">MySQL · RocksDB · 数据的读取(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/mysql-rocksdb-level-compact-analysis.html">MySQL · RocksDB · Level Compact 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/07/mysql-rocksdb-memtable-flush-analysis.html">MySQL · RocksDB · Memtable flush分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/writing-of-mysql.-rocksdb.-memtable.html">MySQL · RocksDB ·  MemTable的写入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/implementation-of-mysql-rocksdb-writing-logic.html">MySQL · RocksDB ·  写入逻辑的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/06/introduction-to-mysql-rocksdb-column-family.html">MySQL · RocksDB · Column Family介绍</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">pagefault.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>nginx中upstream的设计和实现(五) | pagefault</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">nginx中upstream的设计和实现(五)</h1><a id="logo" href="/.">pagefault</a><p class="description">但行好事 莫問前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nginx中upstream的设计和实现(五)</h1><div class="post-meta">Aug 17, 2011<span> | </span><span class="category"><a href="/categories/nginx/">nginx</a><a href="/categories/nginx/server/">server</a></span></div><div class="post-content"><p>这次主要来分析upstream中的发送数据给client, 以及当buf不足，将一部分写到temp file的部分，他们对应的函数分别是ngx_event_pipe_write_to_downstream和ngx_event_pipe_write_chain_to_temp_file.</p>
<p>先来看ngx_event_pipe_write_to_downstream，这个函数顾名思义，就是写buf到临时文件。而所写的buf就是p-&gt;in,也就是将要发送给client的数据。</p>
<p>这个函数，它会处理两类的情况，一类是cache打开，一类是cache未打开。我们这里主要来分析cache关闭的情况。</p>
<p>首先来看这个函数的第一部分的代码,这部分代码主要是遍历p-&gt;in,然后计算能写多少buf到文件(temp file的size是有限制的).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//out就是将要保存到file的数据</span><br><span class="line">      </span><br><span class="line">if (p-&gt;buf_to_file) &#123;</span><br><span class="line">  </span><br><span class="line">//cache打开的情况</span><br><span class="line">          </span><br><span class="line">fl.buf = p-&gt;buf_to_file;</span><br><span class="line">          </span><br><span class="line">fl.next = p-&gt;in;</span><br><span class="line">          </span><br><span class="line">out = &amp;fl;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//得到数据</span><br><span class="line">          </span><br><span class="line">out = p-&gt;in;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果cache没有打开</span><br><span class="line">      </span><br><span class="line">if (!p-&gt;cacheable) &#123;</span><br><span class="line"></span><br><span class="line">size = 0;</span><br><span class="line">          </span><br><span class="line">cl = out;</span><br><span class="line">          </span><br><span class="line">ll = NULL;</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_EVENT, p-&gt;log, 0,</span><br><span class="line">                         </span><br><span class="line">&quot;pipe offset: %O&quot;, p-&gt;temp_file-&gt;offset);</span><br><span class="line">  </span><br><span class="line">//开始遍历out</span><br><span class="line">          </span><br><span class="line">do &#123;</span><br><span class="line">  </span><br><span class="line">//计算大小</span><br><span class="line">              </span><br><span class="line">bsize = cl-&gt;buf-&gt;last &amp;#8211; cl-&gt;buf-&gt;pos;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">  </span><br><span class="line">//看是否超过限制限制</span><br><span class="line">              </span><br><span class="line">if ((size + bsize &gt; p-&gt;temp_file_write_size)</span><br><span class="line">                 </span><br><span class="line">|| (p-&gt;temp_file-&gt;offset + size + bsize &gt; p-&gt;max_temp_file_size))</span><br><span class="line">              </span><br><span class="line">&#123;</span><br><span class="line">                  </span><br><span class="line">break;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">size += bsize;</span><br><span class="line">              </span><br><span class="line">ll = &amp;cl-&gt;next;</span><br><span class="line">              </span><br><span class="line">cl = cl-&gt;next;</span><br><span class="line"></span><br><span class="line">&#125; while (cl);</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_EVENT, p-&gt;log, 0, &quot;size: %z&quot;, size);</span><br><span class="line"></span><br><span class="line">if (ll == NULL) &#123;</span><br><span class="line">              </span><br><span class="line">return NGX_BUSY;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//cl存在则说明只有一部分buf能够写入到temp file，此时p-&gt;in保存剩下的chain</span><br><span class="line">          </span><br><span class="line">if (cl) &#123;</span><br><span class="line">             </span><br><span class="line">p-&gt;in = cl;</span><br><span class="line">             </span><br><span class="line">*ll = NULL;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//否则说明所有的buf都写入到了temp file，此时p-&gt;in则设置为空</span><br><span class="line">             </span><br><span class="line">p-&gt;in = NULL;</span><br><span class="line">             </span><br><span class="line">p-&gt;last_in = &amp;p-&gt;in;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//cache打开的情况，可以看到和上面类似.</span><br><span class="line">          </span><br><span class="line">p-&gt;in = NULL;</span><br><span class="line">          </span><br><span class="line">p-&gt;last_in = &amp;p-&gt;in;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<a id="more"></a>

<p>然后是第二部分，也就是最后一部分，这部分就是写buf到temp file，然后将已经写到temp file的buf，挂载到free_raw_bufs，以供继续使用。这里有用到shadow buf，因为shadow buf的内存是已经分配好的，而当已经写入到temp file之后，这部分buf自然就可以重新使用了。</p>
<p>还有一个很重要的操作，那就是将已经写入到temp file的buf 挂载到p-&gt;out上.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//写out到tempfile</span><br><span class="line">      </span><br><span class="line">if (ngx_write_chain_to_temp_file(p-&gt;temp_file, out) == NGX_ERROR) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_ABORT;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//遍历free_raw_bufs,以便与接下来将使用过的buf挂载到后面。</span><br><span class="line">      </span><br><span class="line">for (last_free = &amp;p-&gt;free_raw_bufs;</span><br><span class="line">           </span><br><span class="line">*last_free != NULL;</span><br><span class="line">           </span><br><span class="line">last_free = &amp;(*last_free)-&gt;next)</span><br><span class="line">      </span><br><span class="line">&#123;</span><br><span class="line">          </span><br><span class="line">/\* void \*/</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (p-&gt;buf_to_file) &#123;</span><br><span class="line">          </span><br><span class="line">p-&gt;temp_file-&gt;offset = p-&gt;buf_to_file-&gt;last &amp;#8211; p-&gt;buf_to_file-&gt;pos;</span><br><span class="line">          </span><br><span class="line">p-&gt;buf_to_file = NULL;</span><br><span class="line">          </span><br><span class="line">out = out-&gt;next;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//遍历out</span><br><span class="line">      </span><br><span class="line">for (cl = out; cl; cl = next) &#123;</span><br><span class="line">          </span><br><span class="line">next = cl-&gt;next;</span><br><span class="line">          </span><br><span class="line">cl-&gt;next = NULL;</span><br><span class="line"></span><br><span class="line">b = cl-&gt;buf;</span><br><span class="line">  </span><br><span class="line">//可以看到重新设置buf为file。然后设置相关属性</span><br><span class="line">          </span><br><span class="line">b-&gt;file = &amp;p-&gt;temp_file-&gt;file;</span><br><span class="line">          </span><br><span class="line">b-&gt;file_pos = p-&gt;temp_file-&gt;offset;</span><br><span class="line">          </span><br><span class="line">p-&gt;temp_file-&gt;offset += b-&gt;last &amp;#8211; b-&gt;pos;</span><br><span class="line">          </span><br><span class="line">b-&gt;file_last = p-&gt;temp_file-&gt;offset;</span><br><span class="line"></span><br><span class="line">b-&gt;in_file = 1;</span><br><span class="line">          </span><br><span class="line">b-&gt;temp_file = 1;</span><br><span class="line">  </span><br><span class="line">//这里就是将buf放入到p-&gt;out.</span><br><span class="line">          </span><br><span class="line">if (p-&gt;out) &#123;</span><br><span class="line">              </span><br><span class="line">*p-&gt;last_out = cl;</span><br><span class="line">          </span><br><span class="line">&#125; else &#123;</span><br><span class="line">              </span><br><span class="line">p-&gt;out = cl;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//设置last_out</span><br><span class="line">          </span><br><span class="line">p-&gt;last_out = &amp;cl-&gt;next;</span><br><span class="line">  </span><br><span class="line">//shadow存在，则将已经保存到file的buf挂载到free_raw_buf中。</span><br><span class="line">          </span><br><span class="line">if (b-&gt;last_shadow) &#123;</span><br><span class="line"></span><br><span class="line">tl = ngx_alloc_chain_link(p-&gt;pool);</span><br><span class="line">              </span><br><span class="line">if (tl == NULL) &#123;</span><br><span class="line">                  </span><br><span class="line">return NGX_ABORT;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//可以看到使用它的shadow</span><br><span class="line">              </span><br><span class="line">tl-&gt;buf = b-&gt;shadow;</span><br><span class="line">              </span><br><span class="line">tl-&gt;next = NULL;</span><br><span class="line">  </span><br><span class="line">//last_free就是free_raw_buf的尾部</span><br><span class="line">              </span><br><span class="line">*last_free = tl;</span><br><span class="line">              </span><br><span class="line">last_free = &amp;tl-&gt;next;</span><br><span class="line">  </span><br><span class="line">//reset buf</span><br><span class="line">              </span><br><span class="line">b-&gt;shadow-&gt;pos = b-&gt;shadow-&gt;start;</span><br><span class="line">              </span><br><span class="line">b-&gt;shadow-&gt;last = b-&gt;shadow-&gt;start;</span><br><span class="line">  </span><br><span class="line">//remove掉shadow。</span><br><span class="line">              </span><br><span class="line">ngx_event_pipe_remove_shadow_links(b-&gt;shadow);</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后来看ngx_event_pipe_write_to_downstream，也就是发送数据到client的部分，这个函数整体是一个大循环， 而在这个大循环内分为三部分，其中第一部分处理upstream已经发送完毕(比如断开连接，出错等)时的情况，第二部分是对发送前的buf进行一些处理(比如busy buf，p-&gt;in,p-&gt;out等),然后循环发送,第三部分就是调用发送接口（output_filter)发送数据，然后update chain.</p>
<p>ok，接下来我们就来看这三部分。先来看第一部分，这部分就是处理upstream端已经发送完毕的情况，此时需要我们立即发送数据到downstream。</p>
<p>这里需要注意的是在upstream发送的时候，对于buf的选择有一个顺序，通过前面一篇blog，我们能看到当拷贝从upstream的数据的时候，就有一个顺序。</p>
<p>这个顺序是这样子的，首先是p-&gt;out,然后是p-&gt;in,因为p-&gt;out保存了一些buf在文件中的buf。</p>
<p>然后时buf的recycle属性，这个属性主要目的是这样子的，由于在p-&gt;input_filter中，nginx制造了一个buf充当已经读取的buf的shadow(last_shadow = 1)，而在以后，nginx操作的都是这个buf，这个buf就被设置为recycled，也就是可以循环利用。而且当设置了recycled，则也将会在发送数据的时候，立即将buf发送出去，而不会缓存(可以看ngx_http_write_filter中的判断).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//判断upstream状态</span><br><span class="line">          </span><br><span class="line">if (p-&gt;upstream_eof || p-&gt;upstream_error || p-&gt;upstream_done) &#123;</span><br><span class="line"></span><br><span class="line">/\* pass the p-&gt;out and p-&gt;in chains to the output filter \*/</span><br><span class="line">  </span><br><span class="line">//取消掉recycled设置，</span><br><span class="line">              </span><br><span class="line">for (cl = p-&gt;busy; cl; cl = cl-&gt;next) &#123;</span><br><span class="line">                  </span><br><span class="line">cl-&gt;buf-&gt;recycled = 0;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//首先发送p-&gt;out.</span><br><span class="line">              </span><br><span class="line">if (p-&gt;out) &#123;</span><br><span class="line">                  </span><br><span class="line">ngx_log_debug0(NGX_LOG_DEBUG_EVENT, p-&gt;log, 0,</span><br><span class="line">                                 </span><br><span class="line">&quot;pipe write downstream flush out&quot;);</span><br><span class="line">  </span><br><span class="line">//取消掉recycled设置，因为已经不要回收这个buf了(后端不会有数据过来)。</span><br><span class="line">                  </span><br><span class="line">for (cl = p-&gt;out; cl; cl = cl-&gt;next) &#123;</span><br><span class="line">                      </span><br><span class="line">cl-&gt;buf-&gt;recycled = 0;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//调用filter函数</span><br><span class="line">                  </span><br><span class="line">rc = p-&gt;output_filter(p-&gt;output_ctx, p-&gt;out);</span><br><span class="line">  </span><br><span class="line">//如果发送失败，则设置downstream_error,并且回收chain</span><br><span class="line">                  </span><br><span class="line">if (rc == NGX_ERROR) &#123;</span><br><span class="line">                      </span><br><span class="line">p-&gt;downstream_error = 1;</span><br><span class="line">                      </span><br><span class="line">return ngx_event_pipe_drain_chains(p);</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p-&gt;out = NULL;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//发送p-&gt;in</span><br><span class="line">              </span><br><span class="line">if (p-&gt;in) &#123;</span><br><span class="line">                  </span><br><span class="line">ngx_log_debug0(NGX_LOG_DEBUG_EVENT, p-&gt;log, 0,</span><br><span class="line">                                 </span><br><span class="line">&quot;pipe write downstream flush in&quot;);</span><br><span class="line">  </span><br><span class="line">//取消recycled设置</span><br><span class="line">                  </span><br><span class="line">for (cl = p-&gt;in; cl; cl = cl-&gt;next) &#123;</span><br><span class="line">                      </span><br><span class="line">cl-&gt;buf-&gt;recycled = 0;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//发送数据</span><br><span class="line">                  </span><br><span class="line">rc = p-&gt;output_filter(p-&gt;output_ctx, p-&gt;in);</span><br><span class="line">  </span><br><span class="line">//同上</span><br><span class="line">                  </span><br><span class="line">if (rc == NGX_ERROR) &#123;</span><br><span class="line">                      </span><br><span class="line">p-&gt;downstream_error = 1;</span><br><span class="line">                      </span><br><span class="line">return ngx_event_pipe_drain_chains(p);</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p-&gt;in = NULL;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//cache相关设置</span><br><span class="line">              </span><br><span class="line">if (p-&gt;cacheable &amp;&amp; p-&gt;buf_to_file) &#123;</span><br><span class="line"></span><br><span class="line">file.buf = p-&gt;buf_to_file;</span><br><span class="line">                  </span><br><span class="line">file.next = NULL;</span><br><span class="line"></span><br><span class="line">if (ngx_write_chain_to_temp_file(p-&gt;temp_file, &amp;file)</span><br><span class="line">                      </span><br><span class="line">== NGX_ERROR)</span><br><span class="line">                  </span><br><span class="line">&#123;</span><br><span class="line">                      </span><br><span class="line">return NGX_ABORT;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_log_debug0(NGX_LOG_DEBUG_EVENT, p-&gt;log, 0,</span><br><span class="line">                             </span><br><span class="line">&quot;pipe write downstream done&quot;);</span><br><span class="line"></span><br><span class="line">/\* TODO: free unused bufs \*/</span><br><span class="line"></span><br><span class="line">p-&gt;downstream_done = 1;</span><br><span class="line">              </span><br><span class="line">break;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>紧接着是第二部分，这部分主要是处理upstream的数据并没有发送完全，此时nginx会尽量发送最大的可能的数据到client。</p>
<p>这里busy就保存了上次发送没有发送完毕的chain，它主要是为了方便统计。</p>
<p>它的步骤是这样子的，首先会计算busy chain的大小，因为我们有busy chain的限制(有busy buf的命令).然后计算p-&gt;in/p-&gt;out,最后得到一个最大的chain，然后发送。这里要注意，我们发送的每个buf大小是不会大于busy buf的大小的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//判断是否需要退出循环，这里比较关键的就是downstream-&gt;write-&gt;ready，当发送返回again，就会从这里退出</span><br><span class="line">          </span><br><span class="line">if (downstream-&gt;data != p-&gt;output_ctx</span><br><span class="line">              </span><br><span class="line">|| !downstream-&gt;write-&gt;ready</span><br><span class="line">              </span><br><span class="line">|| downstream-&gt;write-&gt;delayed)</span><br><span class="line">          </span><br><span class="line">&#123;</span><br><span class="line">              </span><br><span class="line">break;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">prev = NULL;</span><br><span class="line">          </span><br><span class="line">bsize = 0;</span><br><span class="line">  </span><br><span class="line">//首先计算busy的chain的大小</span><br><span class="line">          </span><br><span class="line">for (cl = p-&gt;busy; cl; cl = cl-&gt;next) &#123;</span><br><span class="line"></span><br><span class="line">if (cl-&gt;buf-&gt;recycled) &#123;</span><br><span class="line">  </span><br><span class="line">//如果是相同的chain，则跳过计算</span><br><span class="line">                  </span><br><span class="line">if (prev == cl-&gt;buf-&gt;start) &#123;</span><br><span class="line">                      </span><br><span class="line">continue;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//计算大小</span><br><span class="line">                  </span><br><span class="line">bsize += cl-&gt;buf-&gt;end &amp;#8211; cl-&gt;buf-&gt;start;</span><br><span class="line">                  </span><br><span class="line">prev = cl-&gt;buf-&gt;start;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_EVENT, p-&gt;log, 0,</span><br><span class="line">                         </span><br><span class="line">&quot;pipe write busy: %uz&quot;, bsize);</span><br><span class="line"></span><br><span class="line">out = NULL;</span><br><span class="line">  </span><br><span class="line">//如果bsize大于我们设置的busy buf size,则直接发送数据</span><br><span class="line">          </span><br><span class="line">if (bsize &gt;= (size_t) p-&gt;busy_size) &#123;</span><br><span class="line">              </span><br><span class="line">flush = 1;</span><br><span class="line">              </span><br><span class="line">goto flush;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flush = 0;</span><br><span class="line">          </span><br><span class="line">ll = NULL;</span><br><span class="line">          </span><br><span class="line">prev_last_shadow = 1;</span><br><span class="line">  </span><br><span class="line">//然后开始处理p-&gt;out和p-&gt;in</span><br><span class="line">          </span><br><span class="line">for ( ;; ) &#123;</span><br><span class="line">              </span><br><span class="line">if (p-&gt;out) &#123;</span><br><span class="line">                  </span><br><span class="line">cl = p-&gt;out;</span><br><span class="line">  </span><br><span class="line">//计算将要发送的buf是否大于我们设置的busy_size，而cl-&gt;buf-&gt;last &amp;#8211; cl-&gt;buf-&gt;pos是肯定小于等于busy_size.</span><br><span class="line">                  </span><br><span class="line">if (cl-&gt;buf-&gt;recycled</span><br><span class="line">                      </span><br><span class="line">&amp;&amp; bsize + cl-&gt;buf-&gt;last &amp;#8211; cl-&gt;buf-&gt;pos &gt; p-&gt;busy_size)</span><br><span class="line">                  </span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">//此时当前的cl就不能发送，所以设置flush，然后立即发送</span><br><span class="line">                      </span><br><span class="line">flush = 1;</span><br><span class="line">                      </span><br><span class="line">break;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p-&gt;out = p-&gt;out-&gt;next;</span><br><span class="line">  </span><br><span class="line">//将shadow buf 放到free_raw_bufs中，以便后面使用</span><br><span class="line">                  </span><br><span class="line">ngx_event_pipe_free_shadow_raw_buf(&amp;p-&gt;free_raw_bufs, cl-&gt;buf);</span><br><span class="line"></span><br><span class="line">&#125; else if (!p-&gt;cacheable &amp;&amp; p-&gt;in) &#123;</span><br><span class="line">                  </span><br><span class="line">cl = p-&gt;in;</span><br><span class="line"></span><br><span class="line">ngx_log_debug3(NGX_LOG_DEBUG_EVENT, p-&gt;log, 0,</span><br><span class="line">                                 </span><br><span class="line">&quot;pipe write buf ls:%d %p %z&quot;,</span><br><span class="line">                                 </span><br><span class="line">cl-&gt;buf-&gt;last_shadow,</span><br><span class="line">                                 </span><br><span class="line">cl-&gt;buf-&gt;pos,</span><br><span class="line">                                 </span><br><span class="line">cl-&gt;buf-&gt;last &amp;#8211; cl-&gt;buf-&gt;pos);</span><br><span class="line">  </span><br><span class="line">//类似上面的，也是需要计算buf大小，这里可以看到我们只操作影子(shadow)buf，</span><br><span class="line">                  </span><br><span class="line">if (cl-&gt;buf-&gt;recycled</span><br><span class="line">                      </span><br><span class="line">&amp;&amp; cl-&gt;buf-&gt;last_shadow</span><br><span class="line">                      </span><br><span class="line">&amp;&amp; bsize + cl-&gt;buf-&gt;last &amp;#8211; cl-&gt;buf-&gt;pos &gt; p-&gt;busy_size)</span><br><span class="line">                  </span><br><span class="line">&#123;</span><br><span class="line">                      </span><br><span class="line">if (!prev_last_shadow) &#123;</span><br><span class="line">  </span><br><span class="line">//设置out chain</span><br><span class="line">                          </span><br><span class="line">p-&gt;in = p-&gt;in-&gt;next;</span><br><span class="line"></span><br><span class="line">cl-&gt;next = NULL;</span><br><span class="line"></span><br><span class="line">if (out) &#123;</span><br><span class="line">                              </span><br><span class="line">*ll = cl;</span><br><span class="line">                          </span><br><span class="line">&#125; else &#123;</span><br><span class="line">                              </span><br><span class="line">out = cl;</span><br><span class="line">                          </span><br><span class="line">&#125;</span><br><span class="line">                      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flush = 1;</span><br><span class="line">                      </span><br><span class="line">break;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">prev_last_shadow = cl-&gt;buf-&gt;last_shadow;</span><br><span class="line"></span><br><span class="line">p-&gt;in = p-&gt;in-&gt;next;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">                  </span><br><span class="line">break;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果cl是recycled，则说明这个buf会被发送，因此bsize更新</span><br><span class="line">              </span><br><span class="line">if (cl-&gt;buf-&gt;recycled) &#123;</span><br><span class="line">                  </span><br><span class="line">bsize += cl-&gt;buf-&gt;last &amp;#8211; cl-&gt;buf-&gt;pos;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cl-&gt;next = NULL;</span><br><span class="line">  </span><br><span class="line">//将对应的chain绑定到out上，接下来就会发送out。</span><br><span class="line">              </span><br><span class="line">if (out) &#123;</span><br><span class="line">                  </span><br><span class="line">*ll = cl;</span><br><span class="line">              </span><br><span class="line">&#125; else &#123;</span><br><span class="line">                  </span><br><span class="line">out = cl;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">ll = &amp;cl-&gt;next;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是最后一部分，也就是发送chain，然后update chain的操作(类似chain output的操作)</p>
<p>这里用有一个很重要的操作，通过上面的分析我们知道，在upstream中，基本上每个buf都会有一个shadow，而我们发送的时候，用的是shadow(last_shadow=1),当发送完毕，这个buf会被放到p-&gt;free中，此时还有一个buf，那就是原始的buf(这个buf是有分配内存的,b-&gt;start不为null)，因此这里就可以重用这个buf，在nginx中会将发送完毕后的这个buf放到free_raw_buf中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">flush:</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line">  </span><br><span class="line">//发送数据到client</span><br><span class="line">          </span><br><span class="line">rc = p-&gt;output_filter(p-&gt;output_ctx, out);</span><br><span class="line">  </span><br><span class="line">//错误的话，设置downstream_error</span><br><span class="line">          </span><br><span class="line">if (rc == NGX_ERROR) &#123;</span><br><span class="line">              </span><br><span class="line">p-&gt;downstream_error = 1;</span><br><span class="line">              </span><br><span class="line">return ngx_event_pipe_drain_chains(p);</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//update chain,将已经完全发送的chain保存到free，还没发送的保存到busy.</span><br><span class="line">          </span><br><span class="line">ngx_chain_update_chains(&amp;p-&gt;free, &amp;p-&gt;busy, &amp;out, p-&gt;tag);</span><br><span class="line">  </span><br><span class="line">//遍历free chain,</span><br><span class="line">          </span><br><span class="line">for (cl = p-&gt;free; cl; cl = cl-&gt;next) &#123;</span><br><span class="line"></span><br><span class="line">if (cl-&gt;buf-&gt;temp_file) &#123;</span><br><span class="line">                  </span><br><span class="line">if (p-&gt;cacheable || !p-&gt;cyclic_temp_file) &#123;</span><br><span class="line">                      </span><br><span class="line">continue;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/\* reset p-&gt;temp_offset if all bufs had been sent \*/</span><br><span class="line"></span><br><span class="line">if (cl-&gt;buf-&gt;file_last == p-&gt;temp_file-&gt;offset) &#123;</span><br><span class="line">                      </span><br><span class="line">p-&gt;temp_file-&gt;offset = 0;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/\* TODO: free buf if p-&gt;free_bufs &amp;&amp; upstream done \*/</span><br><span class="line"></span><br><span class="line">/\* add the free shadow raw buf to p-&gt;free_raw_bufs \*/</span><br><span class="line">  </span><br><span class="line">//将shadow的buf放到p-&gt;free_raw_buf中.</span><br><span class="line">              </span><br><span class="line">if (cl-&gt;buf-&gt;last_shadow) &#123;</span><br><span class="line">  </span><br><span class="line">//可以看到这里操作的是cl-&gt;buf-&gt;shadow,也就是我们在p-&gt;input_filter中，拷贝的那个原始buf。</span><br><span class="line">                  </span><br><span class="line">if (ngx_event_pipe_add_free_buf(p, cl-&gt;buf-&gt;shadow) != NGX_OK) &#123;</span><br><span class="line">                      </span><br><span class="line">return NGX_ABORT;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cl-&gt;buf-&gt;last_shadow = 0;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cl-&gt;buf-&gt;shadow = NULL;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的分析，还遗漏了一个函数，那就是ngx_event_pipe_drain_chains，这个函数被调用，说明client出错，此时则需要将对应的shadow buf放到free_raw_buf中(调用(ngx_event_pipe_add_free_buf).</p>
<p>最后还有一个问题没解决，那就是当client断开连接时(当接收完毕所有的header)，nginx如何来处理，通过上面的代码，我们能够看到，当发送数据失败时，只是调用ngx_event_pipe_drain_chains然后返回，那么其实这里处理和nginx处理一般的http请求是一样的，那就是暂时忽略client的断开，也就是不管client的状态，当upstream发送完毕，才会认为request处理完成，这样子能简化代码的处理。</p>
<p>并且，这里只有cache没有打开的时候，才会finalize 当前的request，这是因为当cache打开的时候，当前的request 是需要被cache，然后下次请求再次到达，就可以发送cache的了。所以此时需要接受完后端所有的数据。</p>
<p>下面我们就来看这部分代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static void</span><br><span class="line">  </span><br><span class="line">ngx_http_upstream_process_request(ngx_http_request_t *r)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t del;</span><br><span class="line">      </span><br><span class="line">ngx_temp_file_t *tf;</span><br><span class="line">      </span><br><span class="line">ngx_event_pipe_t *p;</span><br><span class="line">      </span><br><span class="line">ngx_http_upstream_t *u;</span><br><span class="line"></span><br><span class="line">u = r-&gt;upstream;</span><br><span class="line">      </span><br><span class="line">p = u-&gt;pipe;</span><br><span class="line">  </span><br><span class="line">//当finalize upstream之后，connection将会被赋值为NULL</span><br><span class="line">      </span><br><span class="line">if (u-&gt;peer.connection) &#123;</span><br><span class="line"></span><br><span class="line">if (u-&gt;store) &#123;</span><br><span class="line"></span><br><span class="line">del = p-&gt;upstream_error;</span><br><span class="line"></span><br><span class="line">tf = u-&gt;pipe-&gt;temp_file;</span><br><span class="line"></span><br><span class="line">if (p-&gt;upstream_eof || p-&gt;upstream_done) &#123;</span><br><span class="line"></span><br><span class="line">if (u-&gt;headers_in.status_n == NGX_HTTP_OK</span><br><span class="line">                      </span><br><span class="line">&amp;&amp; (u-&gt;headers_in.content_length_n == -1</span><br><span class="line">                          </span><br><span class="line">|| (u-&gt;headers_in.content_length_n == tf-&gt;offset)))</span><br><span class="line">                  </span><br><span class="line">&#123;</span><br><span class="line">                      </span><br><span class="line">ngx_http_upstream_store(r, u);</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">                      </span><br><span class="line">del = 1;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (del &amp;&amp; tf-&gt;file.fd != NGX_INVALID_FILE) &#123;</span><br><span class="line"></span><br><span class="line">if (ngx_delete_file(tf-&gt;file.name.data) == NGX_FILE_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">ngx_log_error(NGX_LOG_CRIT, r-&gt;connection-&gt;log, ngx_errno,</span><br><span class="line">                                    </span><br><span class="line">ngx_delete_file_n &quot; \&quot;%s\&quot; failed&quot;,</span><br><span class="line">                                    </span><br><span class="line">u-&gt;pipe-&gt;temp_file-&gt;file.name.data);</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果upstream端发送完毕(断开等),则finalize request。</span><br><span class="line">          </span><br><span class="line">if (p-&gt;upstream_done || p-&gt;upstream_eof || p-&gt;upstream_error) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                             </span><br><span class="line">&quot;http upstream exit: %p&quot;, p-&gt;out);</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u, 0);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果downstream error设置，则进入下面的处理</span><br><span class="line">      </span><br><span class="line">if (p-&gt;downstream_error) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                         </span><br><span class="line">&quot;http upstream downstream error&quot;);</span><br><span class="line">  </span><br><span class="line">//这里可以看到如果cache没有打开，则finalize 当前的request</span><br><span class="line">          </span><br><span class="line">if (!u-&gt;cacheable &amp;&amp; !u-&gt;store &amp;&amp; u-&gt;peer.connection) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u, 0);</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tags"><a href="/tags/nginx/">nginx</a><a href="/tags/server/">server</a><a href="/tags/web-server/">web server</a></div><div class="post-nav"><a class="pre" href="/2011/08/28/linux-tcp-option-tcpdeferaccept-detailed.html">linux下tcp选项TCP_DEFER_ACCEPT详解</a><a class="next" href="/2011/08/06/design-and-implementation-of-upstream-in-nginx-4.html">nginx中upstream的设计和实现(四)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/">SPDY</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/协议/">协议</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/server/">server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/lua/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/">server</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/源码阅读/">源码阅读</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/语言规范/">语言规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/rocksdb/" style="font-size: 15px;">rocksdb</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/server/" style="font-size: 15px;">server</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/aio/" style="font-size: 15px;">aio</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/process/" style="font-size: 15px;">process</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a> <a href="/tags/google/" style="font-size: 15px;">google</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/路由/" style="font-size: 15px;">路由</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TFO/" style="font-size: 15px;">TFO</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/语言规范/" style="font-size: 15px;">语言规范</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/spdy/" style="font-size: 15px;">spdy</a> <a href="/tags/kenel/" style="font-size: 15px;">kenel</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/InnoDB/" style="font-size: 15px;">InnoDB</a> <a href="/tags/sever/" style="font-size: 15px;">sever</a> <a href="/tags/rfs/" style="font-size: 15px;">rfs</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/congest/" style="font-size: 15px;">congest</a> <a href="/tags/server，mm/" style="font-size: 15px;">server，mm</a> <a href="/tags/web-server/" style="font-size: 15px;">web server</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/pipeline/" style="font-size: 15px;">pipeline</a> <a href="/tags/tcp-cork/" style="font-size: 15px;">tcp_cork</a> <a href="/tags/服务器设计/" style="font-size: 15px;">服务器设计</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/mochiweb/" style="font-size: 15px;">mochiweb</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/loadbalance/" style="font-size: 15px;">loadbalance</a> <a href="/tags/glibc/" style="font-size: 15px;">glibc</a> <a href="/tags/systemcall/" style="font-size: 15px;">systemcall</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/gro/" style="font-size: 15px;">gro</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/19/redo-log-design-and-implementation-in-innodb-1.html">InnoDB中Redo log设计与实现(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/mtr-minitransaction-design-and-implementation.html">MTR(mini-transaction)设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/design-and-implementation-of-linkbuf-in-innodb.html">InnoDB中LinkBuf设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/innodb-tablespace-source-code-analysis.html">InnoDB tablespace源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/mysql-·-rocksdb-data-reading-2.html">MySQL · RocksDB · 数据的读取(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/mysql-·-rocksdb-data-reading-1.html">MySQL · RocksDB · 数据的读取(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/mysql-·-rocksdb-level-compact-analysis.html">MySQL · RocksDB · Level Compact 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/07/mysql-·-rocksdb-memtable-flush-analysis.html">MySQL · RocksDB · Memtable flush分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/mysql-·-rocksdb-memtable-write.html">MySQL · RocksDB ·  MemTable的写入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/mysql-·-rocksdb-implementation-of-write-logic.html">MySQL · RocksDB ·  写入逻辑的实现</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">pagefault.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
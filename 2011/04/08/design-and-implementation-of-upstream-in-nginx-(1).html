<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>nginx中upstream的设计和实现(一) | pagefault</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">nginx中upstream的设计和实现(一)</h1><a id="logo" href="/.">pagefault</a><p class="description">但行好事 莫問前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nginx中upstream的设计和实现(一)</h1><div class="post-meta">Apr 8, 2011<span> | </span><span class="category"><a href="/categories/nginx/">nginx</a><a href="/categories/nginx/server/">server</a><a href="/categories/nginx/server/源码阅读/">源码阅读</a></span></div><div class="post-content"><p>在nginx的模块中，分为3种类型，分别是handler，filter和upstream，其中upstream可以看做一种特殊的handler，它主要用来实现和后端另外的服务器(php/jboss等)进行通信，由于在nginx中全部都是使用非阻塞，并且是一个流式的处理，所以upstream的实现很复杂，接下来我会通过几篇blog来详细的分析下nginx中upstream的设计和实现。</p>
<p>upstream顾名思义，真正产生内容的地方在&#8221;上游&#8221;而不是nginx，也就是说nginx是位于client和后端的upstream之间的桥梁，在这种情况下，一个upstream需要做的事情主要有2个，第一个是当client发送http请求过来之后，需要创建一个到后端upstream的请求。第二个是当后端发送数据过来之后，需要将后端upstream的数据再次发送给client.接下来会看到，我们编写一个upstream模块，最主要也是这两个hook方法。</p>
<p>首先来看如果我们要写一个upstream模块的话，大体的步骤是什么，我们以memcached模块为例子，我们会看到如果我们自己编写upstream模块的话，只需要编写upstream需要的一些hook函数，然后挂载到upstream上就可以了。</p>
<a id="more"></a>
<p>首先来看它的初始化部分。这个函数是命令memcached_pass的handle，它主要做了两件事情，第一件是保存目的upstream(memcached_pass 的参数).第二个是设置core module的handler(这个handler会在update_location中设置给content_handle)，也就是说一个upstream其实也就是一个处于content phase的handler。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static char *</span><br><span class="line">  </span><br><span class="line">ngx_http_memcached_pass(ngx_conf_t \*cf, ngx_command_t \*cmd, void *conf)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">ngx_memzero(&amp;u, sizeof(ngx_url_t));</span><br><span class="line">      </span><br><span class="line">u.url = value[1];</span><br><span class="line">      </span><br><span class="line">u.no_resolve = 1;</span><br><span class="line">  </span><br><span class="line">//根据url，取得对应的upstream</span><br><span class="line">      </span><br><span class="line">mlcf-&gt;upstream.upstream = ngx_http_upstream_add(cf, &amp;u, 0);</span><br><span class="line">      </span><br><span class="line">if (mlcf-&gt;upstream.upstream == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clcf = ngx_http_conf_get_module_loc_conf(cf, ngx_http_core_module);</span><br><span class="line">  </span><br><span class="line">//设置handler</span><br><span class="line">      </span><br><span class="line">clcf-&gt;handler = ngx_http_memcached_handler;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br></pre></td></tr></table></figure>
<p>然后来看ngx_http_memcached_handler，它主要是初始化upstream的相关回调，然后调用ngx_http_upstream_init设置对应的读写回调等等其他的操作。这里我们要主要看它设置的几个回调函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static ngx_int_t</span><br><span class="line">  </span><br><span class="line">ngx_http_memcached_handler(ngx_http_request_t *r)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_int_t rc;</span><br><span class="line">      </span><br><span class="line">ngx_http_upstream_t *u;</span><br><span class="line">      </span><br><span class="line">ngx_http_memcached_ctx_t *ctx;</span><br><span class="line">      </span><br><span class="line">ngx_http_memcached_loc_conf_t *mlcf;</span><br><span class="line"></span><br><span class="line">if (!(r-&gt;method &amp; (NGX_HTTP_GET|NGX_HTTP_HEAD))) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_HTTP_NOT_ALLOWED;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//首先discard request body</span><br><span class="line">      </span><br><span class="line">rc = ngx_http_discard_request_body(r);</span><br><span class="line"></span><br><span class="line">if (rc != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">return rc;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//设置content type。</span><br><span class="line">      </span><br><span class="line">if (ngx_http_set_content_type(r) != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//创建一个upstream</span><br><span class="line">      </span><br><span class="line">if (ngx_http_upstream_create(r) != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u = r-&gt;upstream;</span><br><span class="line">  </span><br><span class="line">//设置schema</span><br><span class="line">      </span><br><span class="line">ngx_str_set(&amp;u-&gt;schema, &quot;memcached://&quot;);</span><br><span class="line">      </span><br><span class="line">u-&gt;output.tag = (ngx_buf_tag_t) &amp;ngx_http_memcached_module;</span><br><span class="line"></span><br><span class="line">mlcf = ngx_http_get_module_loc_conf(r, ngx_http_memcached_module);</span><br><span class="line">  </span><br><span class="line">//设置config，可以看到它就是在memcached_pass中add的upstream</span><br><span class="line">      </span><br><span class="line">u-&gt;conf = &amp;mlcf-&gt;upstream;</span><br><span class="line">  </span><br><span class="line">//开始设置回调，接下来会解释这几个回调的含义</span><br><span class="line">      </span><br><span class="line">u-&gt;create_request = ngx_http_memcached_create_request;</span><br><span class="line">      </span><br><span class="line">u-&gt;reinit_request = ngx_http_memcached_reinit_request;</span><br><span class="line">      </span><br><span class="line">u-&gt;process_header = ngx_http_memcached_process_header;</span><br><span class="line">      </span><br><span class="line">u-&gt;abort_request = ngx_http_memcached_abort_request;</span><br><span class="line">      </span><br><span class="line">u-&gt;finalize_request = ngx_http_memcached_finalize_request;</span><br><span class="line">  </span><br><span class="line">//创建上下文</span><br><span class="line">      </span><br><span class="line">ctx = ngx_palloc(r-&gt;pool, sizeof(ngx_http_memcached_ctx_t));</span><br><span class="line">      </span><br><span class="line">if (ctx == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx-&gt;rest = NGX_HTTP_MEMCACHED_END;</span><br><span class="line">      </span><br><span class="line">ctx-&gt;request = r;</span><br><span class="line"></span><br><span class="line">ngx_http_set_ctx(r, ctx, ngx_http_memcached_module);</span><br><span class="line">  </span><br><span class="line">//设置另外的回调，这几个回调主要是针对非buffering的情况</span><br><span class="line">      </span><br><span class="line">u-&gt;input_filter_init = ngx_http_memcached_filter_init;</span><br><span class="line">      </span><br><span class="line">u-&gt;input_filter = ngx_http_memcached_filter;</span><br><span class="line">      </span><br><span class="line">u-&gt;input_filter_ctx = ctx;</span><br><span class="line"></span><br><span class="line">r-&gt;main-&gt;count++;</span><br><span class="line">  </span><br><span class="line">//进入upstream的处理，接下来就会详细分析这个函数</span><br><span class="line">      </span><br><span class="line">ngx_http_upstream_init(r);</span><br><span class="line"></span><br><span class="line">return NGX_DONE;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok，接下来来看上面设置到的几个回调函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//这个回调是创建到后端upstream的request时候被调用.</span><br><span class="line">      </span><br><span class="line">ngx_int_t (\*create_request)(ngx_http_request_t \*r);</span><br><span class="line">  </span><br><span class="line">//这个是重新初始化到后端upstream的请求，主要是重新初始化context</span><br><span class="line">      </span><br><span class="line">ngx_int_t (\*reinit_request)(ngx_http_request_t \*r);</span><br><span class="line">  </span><br><span class="line">//这个是当后端upstream发送数据到nginx，然后nginx解析这个数据的时候被调用</span><br><span class="line">      </span><br><span class="line">ngx_int_t (\*process_header)(ngx_http_request_t \*r);</span><br><span class="line">  </span><br><span class="line">//这个回调暂时还没有nginx使用</span><br><span class="line">      </span><br><span class="line">void (\*abort_request)(ngx_http_request_t \*r);</span><br><span class="line">  </span><br><span class="line">//request(和后端upstream)结束，需要释放资源</span><br><span class="line">      </span><br><span class="line">void (\*finalize_request)(ngx_http_request_t \*r,</span><br><span class="line">                                           </span><br><span class="line">ngx_int_t rc);</span><br><span class="line">  </span><br><span class="line">//用于upstream中的重定向</span><br><span class="line">      </span><br><span class="line">ngx_int_t (\*rewrite_redirect)(ngx_http_request_t \*r,</span><br><span class="line">                                           </span><br><span class="line">ngx_table_elt_t *h, size_t prefix);</span><br></pre></td></tr></table></figure>
<p>其实除了上面的几个回调，还有几个很重要的回调，那几个我们在后面会详细分析。</p>
<p>接下来我们就跳出memcached模块，进入upstream 模块的处理分析了，首先来看下面upstream初始化基本的流程图，下面这张图只到挂载完upstream的读写回调函数。</p>
<p><a href="http://www.flickr.com/photos/67458145@N00/5584325156/" title="upstream1 by Minibobo, on Flickr" target="_blank" rel="noopener"><img src="http://farm6.static.flickr.com/5185/5584325156_3857eafb3f.jpg" width="259" height="500" alt="upstream1"></a></p>
<p>从上面的memcached的最后一部分，我们看到最终调用 ngx_http_upstream_init(r)进入upstream的处理，我们就从这个函数开始来分析upstream的初始化实现。</p>
<p>这个函数首先删除设置的定时器，然后如果是边缘触发的话，则挂载write的事件，这是因为走upstream，如果接下来我们connect不成功(NGX_EINPROGRESS),则不会进入ngx_http_finalize_request以挂载写hook(前面request的blog有介绍这部分),所以这里我们需要先挂载写事件.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">void</span><br><span class="line">  </span><br><span class="line">ngx_http_upstream_init(ngx_http_request_t *r)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_connection_t *c;</span><br><span class="line"></span><br><span class="line">c = r-&gt;connection;</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c-&gt;log, 0,</span><br><span class="line">                     </span><br><span class="line">&quot;http init upstream, client timer: %d&quot;, c-&gt;read-&gt;timer_set);</span><br><span class="line">  </span><br><span class="line">//删除定时器</span><br><span class="line">      </span><br><span class="line">if (c-&gt;read-&gt;timer_set) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_del_timer(c-&gt;read);</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//挂载写事件</span><br><span class="line">      </span><br><span class="line">if (ngx_event_flags &amp; NGX_USE_CLEAR_EVENT) &#123;</span><br><span class="line"></span><br><span class="line">if (!c-&gt;write-&gt;active) &#123;</span><br><span class="line">              </span><br><span class="line">if (ngx_add_event(c-&gt;write, NGX_WRITE_EVENT, NGX_CLEAR_EVENT)</span><br><span class="line">                  </span><br><span class="line">== NGX_ERROR)</span><br><span class="line">              </span><br><span class="line">&#123;</span><br><span class="line">                  </span><br><span class="line">ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                  </span><br><span class="line">return;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//进入upstream的初始化</span><br><span class="line">      </span><br><span class="line">ngx_http_upstream_init_request(r);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就来详细分析ngx_http_upstream_init_reques，这个函数比较长，我们一段段来看。</p>
<p>下面这段主要是创建将要发送给后端upstream的请求，这里可以看到调用的是create_request这个回调函数，这个函数是我们编写upstream函数时，挂载的hook之一。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">u-&gt;store = (u-&gt;conf-&gt;store || u-&gt;conf-&gt;store_lengths);</span><br><span class="line"></span><br><span class="line">if (!u-&gt;store &amp;&amp; !r-&gt;post_action &amp;&amp; !u-&gt;conf-&gt;ignore_client_abort) &#123;</span><br><span class="line">          </span><br><span class="line">r-&gt;read_event_handler = ngx_http_upstream_rd_check_broken_connection;</span><br><span class="line">          </span><br><span class="line">r-&gt;write_event_handler = ngx_http_upstream_wr_check_broken_connection;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (r-&gt;request_body) &#123;</span><br><span class="line">          </span><br><span class="line">u-&gt;request_bufs = r-&gt;request_body-&gt;bufs;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//调用create_request来创建请求</span><br><span class="line">      </span><br><span class="line">if (u-&gt;create_request(r) != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来这段是初始化upstream的一些属性.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">u-&gt;peer.local = u-&gt;conf-&gt;local;</span><br><span class="line"></span><br><span class="line">clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">u-&gt;output.alignment = clcf-&gt;directio_alignment;</span><br><span class="line">      </span><br><span class="line">u-&gt;output.pool = r-&gt;pool;</span><br><span class="line">      </span><br><span class="line">u-&gt;output.bufs.num = 1;</span><br><span class="line">      </span><br><span class="line">u-&gt;output.bufs.size = clcf-&gt;client_body_buffer_size;</span><br><span class="line">      </span><br><span class="line">u-&gt;output.output_filter = ngx_chain_writer;</span><br><span class="line">      </span><br><span class="line">u-&gt;output.filter_ctx = &amp;u-&gt;writer;</span><br></pre></td></tr></table></figure>
<p>然后接下来就是初始化upstream_states数组，这个数组主要是保存了当前的upstream的一些状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//初始化upstream states</span><br><span class="line">      </span><br><span class="line">if (r-&gt;upstream_states == NULL) &#123;</span><br><span class="line"></span><br><span class="line">r-&gt;upstream_states = ngx_array_create(r-&gt;pool, 1,</span><br><span class="line">                                              </span><br><span class="line">sizeof(ngx_http_upstream_state_t));</span><br><span class="line">          </span><br><span class="line">if (r-&gt;upstream_states == NULL) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">          </span><br><span class="line">u-&gt;state = ngx_array_push(r-&gt;upstream_states);</span><br><span class="line">          </span><br><span class="line">if (u-&gt;state == NULL) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_memzero(u-&gt;state, sizeof(ngx_http_upstream_state_t));</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//开始挂载清理回调函数</span><br><span class="line">      </span><br><span class="line">cln = ngx_http_cleanup_add(r, 0);</span><br><span class="line">      </span><br><span class="line">if (cln == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cln-&gt;handler = ngx_http_upstream_cleanup;</span><br><span class="line">      </span><br><span class="line">cln-&gt;data = r;</span><br><span class="line">      </span><br><span class="line">u-&gt;cleanup = &amp;cln-&gt;handler;</span><br></pre></td></tr></table></figure>
<p>然后就是这个函数最核心的处理部分，那就是根据upstream的类型来进行不同的操作，这里的upstream就是我们通过XXX_pass传递进来的值，这里的upstream有可能下面几种情况。</p>
<p>1 XXX_pass中不包含变量。</p>
<p>2 XXX_pass传递的值包含了一个变量($开始).这种情况也就是说upstream的url是动态变化的，因此需要每次都解析一遍.</p>
<p>而第二种情况又分为2种，一种是在进入upstream之前，也就是 upstream模块的handler之中已经被resolve的地址(请看ngx_http_XXX_eval函数)，一种是没有被resolve，此时就需要upstream模块来进行resolve。</p>
<p>接下来的代码就是处理这部分的东西。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">if (u-&gt;resolved == NULL) &#123;</span><br><span class="line">  </span><br><span class="line">//这里的话，在XXX_pass命令被解析的时候，upstream已经被解析完毕了.</span><br><span class="line">          </span><br><span class="line">uscf = u-&gt;conf-&gt;upstream;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//如果地址已经被resolve过了，此时创建round robin peer</span><br><span class="line">          </span><br><span class="line">if (u-&gt;resolved-&gt;sockaddr) &#123;</span><br><span class="line"></span><br><span class="line">if (ngx_http_upstream_create_round_robin_peer(r, u-&gt;resolved)</span><br><span class="line">                  </span><br><span class="line">!= NGX_OK)</span><br><span class="line">              </span><br><span class="line">&#123;</span><br><span class="line">                  </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                  </span><br><span class="line">return;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//然后开始连接后端的upstream</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_connect(r, u);</span><br><span class="line"></span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//否则需要resolve host到ip地址</span><br><span class="line">          </span><br><span class="line">host = &amp;u-&gt;resolved-&gt;host;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line"></span><br><span class="line">temp.name = *host;</span><br><span class="line"></span><br><span class="line">ctx = ngx_resolve_start(clcf-&gt;resolver, &amp;temp);</span><br><span class="line">          </span><br><span class="line">if (ctx == NULL) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line"></span><br><span class="line">ctx-&gt;name = *host;</span><br><span class="line">          </span><br><span class="line">ctx-&gt;type = NGX_RESOLVE_A;</span><br><span class="line">  </span><br><span class="line">//设置handler，最终在下面的ngx_resolve_name中会调用这个handler。</span><br><span class="line">          </span><br><span class="line">ctx-&gt;handler = ngx_http_upstream_resolve_handler;</span><br><span class="line">          </span><br><span class="line">ctx-&gt;data = r;</span><br><span class="line">          </span><br><span class="line">ctx-&gt;timeout = clcf-&gt;resolver_timeout;</span><br><span class="line"></span><br><span class="line">u-&gt;resolved-&gt;ctx = ctx;</span><br><span class="line">  </span><br><span class="line">//resolve hostname，然后会调用上面的handler</span><br><span class="line">          </span><br><span class="line">if (ngx_resolve_name(ctx) != NGX_OK) &#123;</span><br><span class="line">              </span><br><span class="line">u-&gt;resolved-&gt;ctx = NULL;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们来看ngx_http_upstream_resolve_handler，它做得事情和上面的u-&gt;resolved-&gt;sockaddr存在的分支类似，也是创建peer然后连接对端.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static void</span><br><span class="line">  </span><br><span class="line">ngx_http_upstream_resolve_handler(ngx_resolver_ctx_t *ctx)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">if (ngx_http_upstream_create_round_robin_peer(r, ur) != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                             </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_resolve_name_done(ctx);</span><br><span class="line">      </span><br><span class="line">ur-&gt;ctx = NULL;</span><br><span class="line"></span><br><span class="line">ngx_http_upstream_connect(r, u);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分就先分析到这里，接下来的一篇我会详细分析nginx connect后端upstream以及读写handler的初始化。</p>
</div><div class="tags"><a href="/tags/nginx/">nginx</a></div><div class="post-nav"><a class="pre" href="/2011/04/14/design-and-implementation-of-upstream-in-nginx-(2).html">nginx中upstream的设计和实现(二)</a><a class="next" href="/2011/03/27/basic-concepts-of-routing.html">路由的基本概念介绍</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/">SPDY</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/协议/">协议</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/server/">server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/lua/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/">server</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/源码阅读/">源码阅读</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/语言规范/">语言规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/rocksdb/" style="font-size: 15px;">rocksdb</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/server/" style="font-size: 15px;">server</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/aio/" style="font-size: 15px;">aio</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/process/" style="font-size: 15px;">process</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a> <a href="/tags/google/" style="font-size: 15px;">google</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/路由/" style="font-size: 15px;">路由</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TFO/" style="font-size: 15px;">TFO</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/语言规范/" style="font-size: 15px;">语言规范</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/spdy/" style="font-size: 15px;">spdy</a> <a href="/tags/kenel/" style="font-size: 15px;">kenel</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/sever/" style="font-size: 15px;">sever</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/rfs/" style="font-size: 15px;">rfs</a> <a href="/tags/congest/" style="font-size: 15px;">congest</a> <a href="/tags/web-server/" style="font-size: 15px;">web server</a> <a href="/tags/tcp-cork/" style="font-size: 15px;">tcp_cork</a> <a href="/tags/服务器设计/" style="font-size: 15px;">服务器设计</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/pipeline/" style="font-size: 15px;">pipeline</a> <a href="/tags/server，mm/" style="font-size: 15px;">server，mm</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/mochiweb/" style="font-size: 15px;">mochiweb</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/loadbalance/" style="font-size: 15px;">loadbalance</a> <a href="/tags/InnoDB/" style="font-size: 15px;">InnoDB</a> <a href="/tags/glibc/" style="font-size: 15px;">glibc</a> <a href="/tags/systemcall/" style="font-size: 15px;">systemcall</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/gro/" style="font-size: 15px;">gro</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/design-and-implementation-of-mtr-(mini-transaction).html">MTR(mini-transaction)设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/design-and-implementation-of-linkbuf-in-innodb.html">InnoDB中LinkBuf设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/innodb-tablespace-source-code-analysis.html">InnoDB tablespace源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/.html">MySQL · RocksDB · 数据的读取(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/mysql-rocksdb.-data-reading-(i).html">MySQL · RocksDB · 数据的读取(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/mysql-rocksdb-level-compact-analysis.html">MySQL · RocksDB · Level Compact 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/07/mysql-rocksdb-memtable-flush-analysis.html">MySQL · RocksDB · Memtable flush分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/writing-of-mysql.-rocksdb.-memtable.html">MySQL · RocksDB ·  MemTable的写入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/implementation-of-mysql-rocksdb-writing-logic.html">MySQL · RocksDB ·  写入逻辑的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/06/introduction-to-mysql-rocksdb-column-family.html">MySQL · RocksDB · Column Family介绍</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">pagefault.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
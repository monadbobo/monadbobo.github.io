<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>nginx中upstream的设计和实现(三) | pagefault</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">nginx中upstream的设计和实现(三)</h1><a id="logo" href="/.">pagefault</a><p class="description">但行好事 莫問前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nginx中upstream的设计和实现(三)</h1><div class="post-meta">Apr 27, 2011<span> | </span><span class="category"><a href="/categories/nginx/">nginx</a><a href="/categories/nginx/server/">server</a></span></div><div class="post-content"><p>这次主要来分析当upstream发送过来数据之后，nginx是如何来处理。不过这里我忽略了cache部分，以后我会专门来分析nginx的cache部分。</p>
<p>在前面blog我们能得知upstream端的读回调函数是ngx_http_upstream_process_header，因此这次我们就从ngx_http_upstream_process_header的分析开始。</p>
<p>下面是ngx_http_upstream_process_header执行的流程图.</p>
<p><a href="http://www.flickr.com/photos/67458145@N00/5660159919/" title="upstream_process_header by Minibobo, on Flickr" target="_blank" rel="noopener"><img src="http://farm6.static.flickr.com/5186/5660159919_146459ed32.jpg" width="444" height="456" alt="upstream_process_header"></a></p>
<a id="more"></a>
<p>首先，需要分配内存用来接收后端的数据，这里这个buffer就是u-&gt;buffer,在fastcgi或者proxy中，我们可以通过fastcgi_buffer_size或者proxy_buffer_size对这个值进行设置，它的初始大小是页的大小。</p>
<p>还有一个要注意的就是u-&gt;headers_in，这个头的含义是这样子的，由于upstream是一个通用的组件，因此它不知道后端的协议，而对于client来说，由于http是需要header的，而后端的协议不一定有头，此时就需要我们通过解析后端的协议，然后来设置好发送给client的头，最终发送给client。 </p>
<p>因此此时就需要我们在自己写的upstream模块根据和后端的通信协议来解析数据(就是process_header回调函数)，然后将解析好的数据(header)转换为http的头，此时这些头就是保存在u-&gt;headers_in中(详细可以看下fastcgi和process_header或者proxy的).。这里要注意u-&gt;headers_in的类型和request里面的类型可是不一样的。不过它和r-&gt;headers_in类似，都是将一些常用的头直接放到域里面，而把所有的头都放到u-&gt;headers_in.headers这个list中，因此这里就需要初始化u-&gt;headers_in.headers这个list.而具体这些是如何做的，我们后面会详细分析.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">if (u-&gt;buffer.start == NULL) &#123;</span><br><span class="line">  </span><br><span class="line">//分配一块buffer，可以看到大小为u-&gt;conf-&gt;buffer_size(fastcgi_buffer_size或者proxy_buffer_size)</span><br><span class="line">          </span><br><span class="line">u-&gt;buffer.start = ngx_palloc(r-&gt;pool, u-&gt;conf-&gt;buffer_size);</span><br><span class="line">          </span><br><span class="line">if (u-&gt;buffer.start == NULL) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//然后初始化对应的域</span><br><span class="line">          </span><br><span class="line">u-&gt;buffer.pos = u-&gt;buffer.start;</span><br><span class="line">          </span><br><span class="line">u-&gt;buffer.last = u-&gt;buffer.start;</span><br><span class="line">          </span><br><span class="line">u-&gt;buffer.end = u-&gt;buffer.start + u-&gt;conf-&gt;buffer_size;</span><br><span class="line">          </span><br><span class="line">u-&gt;buffer.temporary = 1;</span><br><span class="line"></span><br><span class="line">u-&gt;buffer.tag = u-&gt;output.tag;</span><br><span class="line">  </span><br><span class="line">//初始化headers.</span><br><span class="line">          </span><br><span class="line">if (ngx_list_init(&amp;u-&gt;headers_in.headers, r-&gt;pool, 8,</span><br><span class="line">                            </span><br><span class="line">sizeof(ngx_table_elt_t))</span><br><span class="line">              </span><br><span class="line">!= NGX_OK)</span><br><span class="line">          </span><br><span class="line">&#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_CACHE)</span><br><span class="line"></span><br><span class="line">if (r-&gt;cache) &#123;</span><br><span class="line">              </span><br><span class="line">u-&gt;buffer.pos += r-&gt;cache-&gt;header_start;</span><br><span class="line">              </span><br><span class="line">u-&gt;buffer.last = u-&gt;buffer.pos;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">#endif</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是从upstream读取数据,判断返回值，处理错误，如果一切正常，则调用u-&gt;process_header,这个也就是我们写upstream模块时，挂载的process_header回调，一般来说，这个回调主要是解析upstream读到数据，得到后端传递过来的头，然后设置u-&gt;headers_in中相关的域.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">for ( ;; ) &#123;</span><br><span class="line">  </span><br><span class="line">//接收数据</span><br><span class="line">          </span><br><span class="line">n = c-&gt;recv(c, u-&gt;buffer.last, u-&gt;buffer.end &amp;#8211; u-&gt;buffer.last);</span><br><span class="line"></span><br><span class="line">if (n == NGX_AGAIN) &#123;</span><br><span class="line">  </span><br><span class="line">#if 0</span><br><span class="line">              </span><br><span class="line">ngx_add_timer(rev, u-&gt;read_timeout);</span><br><span class="line">  </span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">if (ngx_handle_read_event(c-&gt;read, 0) != NGX_OK) &#123;</span><br><span class="line">                  </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                  </span><br><span class="line">return;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果为0，则说明upstream已经关闭了连接</span><br><span class="line">          </span><br><span class="line">if (n == 0) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_log_error(NGX_LOG_ERR, c-&gt;log, 0,</span><br><span class="line">                            </span><br><span class="line">&quot;upstream prematurely closed connection&quot;);</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (n == NGX_ERROR || n == 0) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_next(r, u, NGX_HTTP_UPSTREAM_FT_ERROR);</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//更新buffer</span><br><span class="line">          </span><br><span class="line">u-&gt;buffer.last += n;</span><br><span class="line"></span><br><span class="line">#if 0</span><br><span class="line">          </span><br><span class="line">u-&gt;valid_header_in = 0;</span><br><span class="line"></span><br><span class="line">u-&gt;peer.cached = 0;</span><br><span class="line">  </span><br><span class="line">#endif</span><br><span class="line">  </span><br><span class="line">//然后调用挂载的回调函数</span><br><span class="line">          </span><br><span class="line">rc = u-&gt;process_header(r);</span><br><span class="line">  </span><br><span class="line">//如果返回again，则说明后端的数据发送不完全，此时需要再次读取.</span><br><span class="line">          </span><br><span class="line">if (rc == NGX_AGAIN) &#123;</span><br><span class="line"></span><br><span class="line">if (u-&gt;buffer.pos == u-&gt;buffer.end) &#123;</span><br><span class="line">                  </span><br><span class="line">ngx_log_error(NGX_LOG_ERR, c-&gt;log, 0,</span><br><span class="line">                                </span><br><span class="line">&quot;upstream sent too big header&quot;);</span><br><span class="line"></span><br><span class="line">ngx_http_upstream_next(r, u,</span><br><span class="line">                                         </span><br><span class="line">NGX_HTTP_UPSTREAM_FT_INVALID_HEADER);</span><br><span class="line">                  </span><br><span class="line">return;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">continue;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">break;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok，接下来我会以fastcgi中的process_header的代码片段来分析当调用了u-&gt;process_header之后，都发生了什么事情。</p>
<p>在看这个之前，我们先来看u-&gt;headers_in的结构.,可以看到它和r-&gt;header_out(ngx_http_headers_out_t)很类似，只不过更简单一些。后面我们可以看到为什么这么类似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">typedef struct &#123;</span><br><span class="line">  </span><br><span class="line">//保存了所有的将要传递给client的头</span><br><span class="line">      </span><br><span class="line">ngx_list_t headers;</span><br><span class="line">  </span><br><span class="line">//这里用来设置发送给client的 状态码</span><br><span class="line">      </span><br><span class="line">ngx_uint_t status_n;</span><br><span class="line">      </span><br><span class="line">ngx_str_t status_line;</span><br><span class="line">  </span><br><span class="line">//下面这些头是为了更方便的存取</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *status;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *date;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *server;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *connection;</span><br><span class="line"></span><br><span class="line">ngx_table_elt_t *expires;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *etag;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *x_accel_expires;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *x_accel_redirect;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *x_accel_limit_rate;</span><br><span class="line"></span><br><span class="line">ngx_table_elt_t *content_type;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *content_length;</span><br><span class="line"></span><br><span class="line">ngx_table_elt_t *last_modified;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *location;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *accept_ranges;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *www_authenticate;</span><br><span class="line"></span><br><span class="line">#if (NGX_HTTP_GZIP)</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *content_encoding;</span><br><span class="line">  </span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">off_t content_length_n;</span><br><span class="line"></span><br><span class="line">ngx_array_t cache_control;</span><br><span class="line">  </span><br><span class="line">&#125; ngx_http_upstream_headers_in_t;</span><br></pre></td></tr></table></figure>
<p>然后来看fastcgi的代码片段，下面这段代码就是fastcgi解析upstream中读取的数据，然后将解析到的头设置到u-&gt;headers_in中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">          </span><br><span class="line">for ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">part_start = u-&gt;buffer.pos;</span><br><span class="line">              </span><br><span class="line">part_end = u-&gt;buffer.last;</span><br><span class="line">  </span><br><span class="line">//pase header</span><br><span class="line">              </span><br><span class="line">rc = ngx_http_parse_header_line(r, &amp;u-&gt;buffer, 1);</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                             </span><br><span class="line">&quot;http fastcgi parser: %d&quot;, rc);</span><br><span class="line"></span><br><span class="line">if (rc == NGX_AGAIN) &#123;</span><br><span class="line">                  </span><br><span class="line">break;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//到达这里说明一个header已经被解析出来了.</span><br><span class="line">              </span><br><span class="line">if (rc == NGX_OK) &#123;</span><br><span class="line"></span><br><span class="line">/\* a header line has been parsed successfully \*/</span><br><span class="line">  </span><br><span class="line">//此时从headers list里面取出一个table。</span><br><span class="line">                  </span><br><span class="line">h = ngx_list_push(&amp;u-&gt;headers_in.headers);</span><br><span class="line">                  </span><br><span class="line">if (h == NULL) &#123;</span><br><span class="line">                      </span><br><span class="line">return NGX_ERROR;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (f-&gt;split_parts &amp;&amp; f-&gt;split_parts-&gt;nelts) &#123;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//开始构造头，将解析好的指针赋值给h</span><br><span class="line">                      </span><br><span class="line">h-&gt;key.len = r-&gt;header_name_end &amp;#8211; r-&gt;header_name_start;</span><br><span class="line">                      </span><br><span class="line">h-&gt;value.len = r-&gt;header_end &amp;#8211; r-&gt;header_start;</span><br><span class="line"></span><br><span class="line">h-&gt;key.data = ngx_pnalloc(r-&gt;pool,</span><br><span class="line">                                                </span><br><span class="line">h-&gt;key.len + 1 + h-&gt;value.len + 1</span><br><span class="line">                                                </span><br><span class="line">+ h-&gt;key.len);</span><br><span class="line">                      </span><br><span class="line">if (h-&gt;key.data == NULL) &#123;</span><br><span class="line">                          </span><br><span class="line">return NGX_ERROR;</span><br><span class="line">                      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">h-&gt;value.data = h-&gt;key.data + h-&gt;key.len + 1;</span><br><span class="line">                      </span><br><span class="line">h-&gt;lowcase_key = h-&gt;key.data + h-&gt;key.len + 1</span><br><span class="line">                                       </span><br><span class="line">+ h-&gt;value.len + 1;</span><br><span class="line">  </span><br><span class="line">//开始复制值</span><br><span class="line">                      </span><br><span class="line">ngx_cpystrn(h-&gt;key.data, r-&gt;header_name_start,</span><br><span class="line">                                  </span><br><span class="line">h-&gt;key.len + 1);</span><br><span class="line">                      </span><br><span class="line">ngx_cpystrn(h-&gt;value.data, r-&gt;header_start,</span><br><span class="line">                                  </span><br><span class="line">h-&gt;value.len + 1);</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">h-&gt;hash = r-&gt;header_hash;</span><br><span class="line"></span><br><span class="line">if (h-&gt;key.len == r-&gt;lowcase_index) &#123;</span><br><span class="line">                      </span><br><span class="line">ngx_memcpy(h-&gt;lowcase_key, r-&gt;lowcase_header, h-&gt;key.len);</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">                      </span><br><span class="line">ngx_strlow(h-&gt;lowcase_key, h-&gt;key.data, h-&gt;key.len);</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//先从umcf-&gt;headers_in_hash中查找，这个hash我们紧接着就会分析。</span><br><span class="line">                  </span><br><span class="line">hh = ngx_hash_find(&amp;umcf-&gt;headers_in_hash, h-&gt;hash,</span><br><span class="line">                                     </span><br><span class="line">h-&gt;lowcase_key, h-&gt;key.len);</span><br><span class="line">  </span><br><span class="line">//如果存在则调用hh-&gt;handler,接下来会分析这个.</span><br><span class="line">                  </span><br><span class="line">if (hh &amp;&amp; hh-&gt;handler(r, h, hh-&gt;offset) != NGX_OK) &#123;</span><br><span class="line">                      </span><br><span class="line">return NGX_ERROR;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,</span><br><span class="line">                                 </span><br><span class="line">&quot;http fastcgi header: \&quot;%V: %V\&quot;&quot;,</span><br><span class="line">                                 </span><br><span class="line">&amp;h-&gt;key, &amp;h-&gt;value);</span><br><span class="line"></span><br><span class="line">if (u-&gt;buffer.pos &lt; u-&gt;buffer.last) &#123;</span><br><span class="line">                      </span><br><span class="line">continue;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/\* the end of the FastCGI record \*/</span><br><span class="line"></span><br><span class="line">break;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码有两个疑问，一个是umcf-&gt;headers_in_hash，一个是hh-&gt;handler,接下来就来分析这两个东西。</p>
<p>主要是http有一些头，我们会经常用到，或者有一些头，nginx需要忽略掉(Connection, 因为nginx不支持后端的http 1.1).因此nginx就将这些头特殊处理，常用到的放到固定的域，以便与存取，忽略掉的，则直接赋值为空。</p>
<p>而在nginx中就构造了一个静态数组ngx_http_upstream_headers_in(而umcf-&gt;headers_in_hash里面就是这个数组的元素)，这个数组是ngx_http_upstream_header_t类型的.下面我们先来看这个类型的定义。</p>
<p>这个结构有两个需要注意的域，一个是handler，一个是copy_handler,这两个回调的区别是这样子的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">typedef ngx_int_t (\*ngx_http_header_handler_pt)(ngx_http_request_t \*r,</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t *h, ngx_uint_t offset);</span><br></pre></td></tr></table></figure>
<p>handler回调用于将传递进来的头(ngx_table_elt_t)赋值(只是改变指针)给ngx_http_upstream_headers_in_t中对应的域。</p>
<p>而copy_handler用于将头赋值给r-&gt;header_out,也就是发送给client的头。而可以看到r-&gt;header_out中的大部分header 域的偏移和u-&gt;header_in的偏移是一样的，这样我们赋值给r-&gt;header_out就是非常简单了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">typedef struct &#123;</span><br><span class="line">  </span><br><span class="line">//头的名字</span><br><span class="line">      </span><br><span class="line">ngx_str_t name;</span><br><span class="line">      </span><br><span class="line">ngx_http_header_handler_pt handler;</span><br><span class="line">  </span><br><span class="line">//在ngx_http_upstream_headers_in_t的偏移</span><br><span class="line">      </span><br><span class="line">ngx_uint_t offset;</span><br><span class="line">      </span><br><span class="line">ngx_http_header_handler_pt copy_handler;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t conf;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t redirect; /\* unsigned redirect:1; \*/</span><br><span class="line">  </span><br><span class="line">&#125; ngx_http_upstream_header_t;</span><br></pre></td></tr></table></figure>
<p>然后我们来看ngx_http_upstream_headers_i这个数组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">ngx_http_upstream_header_t ngx_http_upstream_headers_in[] = &#123;</span><br><span class="line"></span><br><span class="line">&#123; ngx_string(&quot;Status&quot;),</span><br><span class="line">                   </span><br><span class="line">ngx_http_upstream_process_header_line,</span><br><span class="line">                   </span><br><span class="line">offsetof(ngx_http_upstream_headers_in_t, status),</span><br><span class="line">                   </span><br><span class="line">ngx_http_upstream_copy_header_line, 0, 0 &#125;,</span><br><span class="line"></span><br><span class="line">&#123; ngx_string(&quot;Content-Type&quot;),</span><br><span class="line">                   </span><br><span class="line">ngx_http_upstream_process_header_line,</span><br><span class="line">                   </span><br><span class="line">offsetof(ngx_http_upstream_headers_in_t, content_type),</span><br><span class="line">                   </span><br><span class="line">ngx_http_upstream_copy_content_type, 0, 1 &#125;,</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面看，这里用的最多的回调就是ngx_http_upstream_process_header_line和ngx_http_upstream_copy_header_line，其它的和他们的功能类似，因此这里我们就详细分析这两个回调，看看里面都是怎么做的。</p>
<p>ngx_http_upstream_process_header_line的做法很简单，取得r-&gt;upstream-&gt;headers_in的指针，然后通过传递进来的偏移来确定header的位置指针，最后将h赋值给它。</p>
<p>这里可以看到如果已经存在则忽略后面的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static ngx_int_t</span><br><span class="line">  </span><br><span class="line">ngx_http_upstream_process_header_line(ngx_http_request_t \*r, ngx_table_elt_t \*h,</span><br><span class="line">      </span><br><span class="line">ngx_uint_t offset)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t **ph;</span><br><span class="line">  </span><br><span class="line">//取得header指针</span><br><span class="line">      </span><br><span class="line">ph = (ngx_table_elt_t *\*) ((char \*) &amp;r-&gt;upstream-&gt;headers_in + offset);</span><br><span class="line"></span><br><span class="line">if (*ph == NULL) &#123;</span><br><span class="line">  </span><br><span class="line">//赋值</span><br><span class="line">          </span><br><span class="line">*ph = h;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return NGX_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是copy handler，它的实现也很简单，就是从r-&gt;headers_out.headers取出来头(这是因为header要在headers和对应的域各保存一个指针)，然后赋值给对应偏移的指针.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static ngx_int_t</span><br><span class="line">  </span><br><span class="line">ngx_http_upstream_copy_header_line(ngx_http_request_t \*r, ngx_table_elt_t \*h,</span><br><span class="line">      </span><br><span class="line">ngx_uint_t offset)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_table_elt_t \*ho, \**ph;</span><br><span class="line">  </span><br><span class="line">//取出header</span><br><span class="line">      </span><br><span class="line">ho = ngx_list_push(&amp;r-&gt;headers_out.headers);</span><br><span class="line">      </span><br><span class="line">if (ho == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">\*ho = \*h;</span><br><span class="line">  </span><br><span class="line">//如果offset存在，则赋值.</span><br><span class="line">      </span><br><span class="line">if (offset) &#123;</span><br><span class="line">          </span><br><span class="line">ph = (ngx_table_elt_t *\*) ((char \*) &amp;r-&gt;headers_out + offset);</span><br><span class="line">          </span><br><span class="line">*ph = ho;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return NGX_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>copy_handler是什么时候调用的呢，我们接着分析下面的代码。让我们回到ngx_http_upstream_process_header，来看它后面的代码。</p>
<p>下面的代码就是调用完u-&gt;process_header之后的处理.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">if (rc == NGX_HTTP_UPSTREAM_INVALID_HEADER) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_http_upstream_next(r, u, NGX_HTTP_UPSTREAM_FT_INVALID_HEADER);</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (rc == NGX_ERROR) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                             </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/\* rc == NGX_OK \*/</span><br><span class="line">  </span><br><span class="line">//错误处理.</span><br><span class="line">      </span><br><span class="line">if (u-&gt;headers_in.status_n &gt; NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line"></span><br><span class="line">if (r-&gt;subrequest_in_memory) &#123;</span><br><span class="line">              </span><br><span class="line">u-&gt;buffer.last = u-&gt;buffer.pos;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (ngx_http_upstream_test_next(r, u) == NGX_OK) &#123;</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (ngx_http_upstream_intercept_errors(r, u) == NGX_OK) &#123;</span><br><span class="line">              </span><br><span class="line">return;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//执行后续工作，主要是设置将要发送给client的header(r-&gt;header_out).接下来会详细分析.</span><br><span class="line">      </span><br><span class="line">if (ngx_http_upstream_process_headers(r, u) != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!r-&gt;subrequest_in_memory) &#123;</span><br><span class="line">  </span><br><span class="line">//然后发送response到client端.</span><br><span class="line">          </span><br><span class="line">ngx_http_upstream_send_response(r, u);</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//下面是subrequst的代码，暂时跳过</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br></pre></td></tr></table></figure>
<p>然后来看ngx_http_upstream_process_headers，这个函数会对一个x_accel_redirect的头进行特殊处理，这个头主要是nginx提供了一种机制，让后端的server能够控制访问权限。比如后端限制某个页面不能被用户访问，那么当用户访问这个页面的时候，后端server只需要设置X-Accel-Redirect这个头到一个路径，然后nginx将会输出这个路径的内容给用户.</p>
<p>来看这部分的代码片段.下面这部分就是处理X-Accel-Redirect这个头，首先拷贝header，然后取出X-Accel-Redirect头后面的地址进行内部重定向.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">if (u-&gt;headers_in.x_accel_redirect</span><br><span class="line">          </span><br><span class="line">&amp;&amp; !(u-&gt;conf-&gt;ignore_headers &amp; NGX_HTTP_UPSTREAM_IGN_XA_REDIRECT))</span><br><span class="line">      </span><br><span class="line">&#123;</span><br><span class="line">          </span><br><span class="line">ngx_http_upstream_finalize_request(r, u, NGX_DECLINED);</span><br><span class="line">  </span><br><span class="line">//便利headers</span><br><span class="line">          </span><br><span class="line">part = &amp;u-&gt;headers_in.headers.part;</span><br><span class="line">          </span><br><span class="line">h = part-&gt;elts;</span><br><span class="line"></span><br><span class="line">for (i = 0; /\* void \*/; i++) &#123;</span><br><span class="line"></span><br><span class="line">if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">                  </span><br><span class="line">if (part-&gt;next == NULL) &#123;</span><br><span class="line">                      </span><br><span class="line">break;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">part = part-&gt;next;</span><br><span class="line">                  </span><br><span class="line">h = part-&gt;elts;</span><br><span class="line">                  </span><br><span class="line">i = 0;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果在ngx_http_upstream_headers_in中存在，并且这个头当redirect之后，还是不变的，此时则调用copy_handler.</span><br><span class="line">              </span><br><span class="line">hh = ngx_hash_find(&amp;umcf-&gt;headers_in_hash, h[i].hash,</span><br><span class="line">                                 </span><br><span class="line">h[i].lowcase_key, h[i].key.len);</span><br><span class="line"></span><br><span class="line">if (hh &amp;&amp; hh-&gt;redirect) &#123;</span><br><span class="line">                  </span><br><span class="line">if (hh-&gt;copy_handler(r, &amp;h[i], hh-&gt;conf) != NGX_OK) &#123;</span><br><span class="line">                      </span><br><span class="line">ngx_http_finalize_request(r,</span><br><span class="line">                                                </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                      </span><br><span class="line">return NGX_DONE;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//取出uri</span><br><span class="line">          </span><br><span class="line">uri = &amp;u-&gt;headers_in.x_accel_redirect-&gt;value;</span><br><span class="line">          </span><br><span class="line">ngx_str_null(&amp;args);</span><br><span class="line">          </span><br><span class="line">flags = NGX_HTTP_LOG_UNSAFE;</span><br><span class="line">  </span><br><span class="line">//parse</span><br><span class="line">          </span><br><span class="line">if (ngx_http_parse_unsafe_uri(r, uri, &amp;args, &amp;flags) != NGX_OK) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_finalize_request(r, NGX_HTTP_NOT_FOUND);</span><br><span class="line">              </span><br><span class="line">return NGX_DONE;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (r-&gt;method != NGX_HTTP_HEAD) &#123;</span><br><span class="line">              </span><br><span class="line">r-&gt;method = NGX_HTTP_GET;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r-&gt;valid_unparsed_uri = 0;</span><br><span class="line">  </span><br><span class="line">//内部重定向</span><br><span class="line">          </span><br><span class="line">ngx_http_internal_redirect(r, uri, &amp;args);</span><br><span class="line">          </span><br><span class="line">ngx_http_finalize_request(r, NGX_DONE);</span><br><span class="line">          </span><br><span class="line">return NGX_DONE;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是没有X-Accel-Redirect头的情况.这个时候，前部分和上面处理类似，首先从ngx_http_upstream_headers_in查找，如果存在则调用copy_handler,然后再调用ngx_http_upstream_copy_header_line将剩余的头copy到r-&gt;header_out.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">part = &amp;u-&gt;headers_in.headers.part;</span><br><span class="line">      </span><br><span class="line">h = part-&gt;elts;</span><br><span class="line">  </span><br><span class="line">//开始遍历</span><br><span class="line">      </span><br><span class="line">for (i = 0; /\* void \*/; i++) &#123;</span><br><span class="line"></span><br><span class="line">if (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">              </span><br><span class="line">if (part-&gt;next == NULL) &#123;</span><br><span class="line">                  </span><br><span class="line">break;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">part = part-&gt;next;</span><br><span class="line">              </span><br><span class="line">h = part-&gt;elts;</span><br><span class="line">              </span><br><span class="line">i = 0;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//查找hash，如果是需要hide的头，则continue</span><br><span class="line">          </span><br><span class="line">if (ngx_hash_find(&amp;u-&gt;conf-&gt;hide_headers_hash, h[i].hash,</span><br><span class="line">                            </span><br><span class="line">h[i].lowcase_key, h[i].key.len))</span><br><span class="line">          </span><br><span class="line">&#123;</span><br><span class="line">              </span><br><span class="line">continue;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//否则hash查找</span><br><span class="line">          </span><br><span class="line">hh = ngx_hash_find(&amp;umcf-&gt;headers_in_hash, h[i].hash,</span><br><span class="line">                             </span><br><span class="line">h[i].lowcase_key, h[i].key.len);</span><br><span class="line"></span><br><span class="line">if (hh) &#123;</span><br><span class="line">  </span><br><span class="line">//调用copy_header</span><br><span class="line">              </span><br><span class="line">if (hh-&gt;copy_handler(r, &amp;h[i], hh-&gt;conf) != NGX_OK) &#123;</span><br><span class="line">                  </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">                  </span><br><span class="line">return NGX_DONE;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">continue;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//最后copy剩下的header.</span><br><span class="line">          </span><br><span class="line">if (ngx_http_upstream_copy_header_line(r, &amp;h[i], 0) != NGX_OK) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                                 </span><br><span class="line">NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">              </span><br><span class="line">return NGX_DONE;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次的分析就到这里，下一次我将会详细分析 upstream最复杂的一块，也就是发送数据到client的部分(ngx_http_upstream_send_response).</p>
</div><div class="tags"><a href="/tags/nginx/">nginx</a></div><div class="post-nav"><a class="pre" href="/2011/05/09/.html">TFO(tcp fast open)简介</a><a class="next" href="/2011/04/20/.html">linux kernel中epoll的设计和实现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/">SPDY</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/协议/">协议</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/server/">server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/lua/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/">server</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/源码阅读/">源码阅读</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/语言规范/">语言规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/rocksdb/" style="font-size: 15px;">rocksdb</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/server/" style="font-size: 15px;">server</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/aio/" style="font-size: 15px;">aio</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/process/" style="font-size: 15px;">process</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a> <a href="/tags/google/" style="font-size: 15px;">google</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/路由/" style="font-size: 15px;">路由</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TFO/" style="font-size: 15px;">TFO</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/语言规范/" style="font-size: 15px;">语言规范</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/spdy/" style="font-size: 15px;">spdy</a> <a href="/tags/kenel/" style="font-size: 15px;">kenel</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/InnoDB/" style="font-size: 15px;">InnoDB</a> <a href="/tags/sever/" style="font-size: 15px;">sever</a> <a href="/tags/rfs/" style="font-size: 15px;">rfs</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/server，mm/" style="font-size: 15px;">server，mm</a> <a href="/tags/congest/" style="font-size: 15px;">congest</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/web-server/" style="font-size: 15px;">web server</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/pipeline/" style="font-size: 15px;">pipeline</a> <a href="/tags/服务器设计/" style="font-size: 15px;">服务器设计</a> <a href="/tags/tcp-cork/" style="font-size: 15px;">tcp_cork</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/mochiweb/" style="font-size: 15px;">mochiweb</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/loadbalance/" style="font-size: 15px;">loadbalance</a> <a href="/tags/glibc/" style="font-size: 15px;">glibc</a> <a href="/tags/systemcall/" style="font-size: 15px;">systemcall</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/gro/" style="font-size: 15px;">gro</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/19/design-and-implementation-of-redo-log-in-innodb-(i).html">InnoDB中Redo log设计与实现(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/.html">MTR(mini-transaction)设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/.html">InnoDB中LinkBuf设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/.html">InnoDB tablespace源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/.html">MySQL · RocksDB · 数据的读取(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/.html">MySQL · RocksDB · 数据的读取(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/.html">MySQL · RocksDB · Level Compact 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/07/.html">MySQL · RocksDB · Memtable flush分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/.html">MySQL · RocksDB ·  MemTable的写入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/implementation-of-mysql-rocksdb-writing-logic.html">MySQL · RocksDB ·  写入逻辑的实现</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">pagefault.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
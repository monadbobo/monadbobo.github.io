<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Nginx配置文件解析详解 | pagefault</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx配置文件解析详解</h1><a id="logo" href="/.">pagefault</a><p class="description">但行好事 莫問前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Nginx配置文件解析详解</h1><div class="post-meta">Apr 28, 2012<span> | </span><span class="category"><a href="/categories/nginx/">nginx</a><a href="/categories/nginx/server/">server</a><a href="/categories/nginx/server/源码阅读/">源码阅读</a></span></div><div class="post-content"><p>Nginx的配置解析相关的部分比较绕，比如为何要有4重指针，比如NGX_MAIN_CONF ， loc_conf,NGX_DIRECT_CONF有什么区别呢?这些我前面的blog都有些涉及，这次主要是把配置这块完全拿出来然后来分析下。</p>
<p>首先来看配置解析时的数据结构，这里主要是ngx_conf_t，这个结构保存了解析配置文件所需要的一些域，这个是非常重要的一个数据结构，我们详细来看这个结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">struct ngx_conf_s &#123;</span><br><span class="line">  </span><br><span class="line">//当前解析到的命令名</span><br><span class="line">      </span><br><span class="line">char *name;</span><br><span class="line">  </span><br><span class="line">//当前命令的所有参数</span><br><span class="line">      </span><br><span class="line">ngx_array_t *args;</span><br><span class="line"></span><br><span class="line">//使用的cycle</span><br><span class="line">      </span><br><span class="line">ngx_cycle_t *cycle;</span><br><span class="line">  </span><br><span class="line">//所使用的内存池</span><br><span class="line">      </span><br><span class="line">ngx_pool_t *pool;</span><br><span class="line">  </span><br><span class="line">//这个pool将会在配置解析完毕后释放。</span><br><span class="line">      </span><br><span class="line">ngx_pool_t *temp_pool;</span><br><span class="line">  </span><br><span class="line">//这个表示将要解析的配置文件</span><br><span class="line">      </span><br><span class="line">ngx_conf_file_t *conf_file;</span><br><span class="line">  </span><br><span class="line">//配置log</span><br><span class="line">      </span><br><span class="line">ngx_log_t *log;</span><br><span class="line"></span><br><span class="line">//主要为了提供模块的层次化(后续会详细介绍)</span><br><span class="line">      </span><br><span class="line">void *ctx;</span><br><span class="line">  </span><br><span class="line">//模块类型</span><br><span class="line">      </span><br><span class="line">ngx_uint_t module_type;</span><br><span class="line">  </span><br><span class="line">//命令类型</span><br><span class="line">      </span><br><span class="line">ngx_uint_t cmd_type;</span><br><span class="line"></span><br><span class="line">//模块自定义的handler</span><br><span class="line">      </span><br><span class="line">ngx_conf_handler_pt handler;</span><br><span class="line">  </span><br><span class="line">//自定义handler的conf</span><br><span class="line">      </span><br><span class="line">char *handler_conf;</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>上面的有些域可能现在还是不太理解，不过没关系，接下来就会一个个的分析到。</p>
<p>我们来看配置解析的入口，入口在ngx_init_cycle中,这里比较简单，就是设置ngx_conf_t 然后传递给ngx_conf_parse解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//创建conf_ctx</span><br><span class="line">      </span><br><span class="line">cycle-&gt;conf_ctx = ngx_pcalloc(pool, ngx_max_module \* sizeof(void \*));</span><br><span class="line">      </span><br><span class="line">if (cycle-&gt;conf_ctx == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_destroy_pool(pool);</span><br><span class="line">          </span><br><span class="line">return NULL;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line"></span><br><span class="line">for (i = 0; ngx_modules[i]; i++) &#123;</span><br><span class="line">          </span><br><span class="line">if (ngx_modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">              </span><br><span class="line">continue;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module = ngx_modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">if (module-&gt;create_conf) &#123;</span><br><span class="line">              </span><br><span class="line">rv = module-&gt;create_conf(cycle);</span><br><span class="line">              </span><br><span class="line">if (rv == NULL) &#123;</span><br><span class="line">                  </span><br><span class="line">ngx_destroy_pool(pool);</span><br><span class="line">                  </span><br><span class="line">return NULL;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//这里看到conf_ctx里面就是放对应模块的main conf.</span><br><span class="line">              </span><br><span class="line">cycle-&gt;conf_ctx[ngx_modules[i]-&gt;index] = rv;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">  </span><br><span class="line">//初始化conf</span><br><span class="line">      </span><br><span class="line">conf.ctx = cycle-&gt;conf_ctx;</span><br><span class="line">      </span><br><span class="line">conf.cycle = cycle;</span><br><span class="line">      </span><br><span class="line">conf.pool = pool;</span><br><span class="line">      </span><br><span class="line">conf.log = log;</span><br><span class="line">  </span><br><span class="line">//注意，一开始命令的类型就是MAIN，并且模块类型是core。</span><br><span class="line">      </span><br><span class="line">conf.module_type = NGX_CORE_MODULE;</span><br><span class="line">      </span><br><span class="line">conf.cmd_type = NGX_MAIN_CONF;</span><br><span class="line"></span><br><span class="line">if (ngx_conf_param(&amp;conf) != NGX_CONF_OK) &#123;</span><br><span class="line">          </span><br><span class="line">environ = senv;</span><br><span class="line">          </span><br><span class="line">ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">          </span><br><span class="line">return NULL;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//开始解析文件</span><br><span class="line">      </span><br><span class="line">if (ngx_conf_parse(&amp;conf, &amp;cycle-&gt;conf_file) != NGX_CONF_OK) &#123;</span><br><span class="line">          </span><br><span class="line">environ = senv;</span><br><span class="line">          </span><br><span class="line">ngx_destroy_cycle_pools(&amp;conf);</span><br><span class="line">          </span><br><span class="line">return NULL;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来看ngx_conf_parse,这个函数第二个是将要解析的文件名，不过这里还有一个要注意的，那就是第二个参数可以为空的，如果为空，则说明将要解析的是block中的内容或者param。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">char *</span><br><span class="line">  </span><br><span class="line">ngx_conf_parse(ngx_conf_t \*cf, ngx_str_t \*filename)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">char *rv;</span><br><span class="line">      </span><br><span class="line">ngx_fd_t fd;</span><br><span class="line">      </span><br><span class="line">ngx_int_t rc;</span><br><span class="line">      </span><br><span class="line">ngx_buf_t buf;</span><br><span class="line">      </span><br><span class="line">ngx_conf_file_t *prev, conf_file;</span><br><span class="line">      </span><br><span class="line">enum &#123;</span><br><span class="line">          </span><br><span class="line">parse_file = 0,</span><br><span class="line">          </span><br><span class="line">parse_block,</span><br><span class="line">          </span><br><span class="line">parse_param</span><br><span class="line">      </span><br><span class="line">&#125; type;</span><br><span class="line"></span><br><span class="line">#if (NGX_SUPPRESS_WARN)</span><br><span class="line">      </span><br><span class="line">fd = NGX_INVALID_FILE;</span><br><span class="line">      </span><br><span class="line">prev = NULL;</span><br><span class="line">  </span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">if (filename) &#123;</span><br><span class="line"></span><br><span class="line">/\* open configuration file \*/</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line"></span><br><span class="line">&#125; else if (cf-&gt;conf_file-&gt;file.fd != NGX_INVALID_FILE) &#123;</span><br><span class="line">  </span><br><span class="line">//到这里说明接下来解析的是block中的内容</span><br><span class="line">          </span><br><span class="line">type = parse_block;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//参数</span><br><span class="line">          </span><br><span class="line">type = parse_param;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for ( ;; ) &#123;</span><br><span class="line">          </span><br><span class="line">rc = ngx_conf_read_token(cf);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">           </span><br><span class="line">* ngx_conf_read_token() may return</span><br><span class="line">           </span><br><span class="line">*</span><br><span class="line">           </span><br><span class="line">* NGX_ERROR there is error</span><br><span class="line">           </span><br><span class="line">* NGX_OK the token terminated by &quot;;&quot; was found</span><br><span class="line">           </span><br><span class="line">* NGX_CONF_BLOCK_START the token terminated by &quot;&#123;&quot; was found</span><br><span class="line">           </span><br><span class="line">* NGX_CONF_BLOCK_DONE the &quot;&#125;&quot; was found</span><br><span class="line">           </span><br><span class="line">* NGX_CONF_FILE_DONE the configuration file is done</span><br><span class="line">           </span><br><span class="line">*/</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line"></span><br><span class="line">/\* rc == NGX_OK || rc == NGX_CONF_BLOCK_START \*/</span><br><span class="line">  </span><br><span class="line">//如果有handler，则调用handle</span><br><span class="line">          </span><br><span class="line">if (cf-&gt;handler) &#123;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">               </span><br><span class="line">* the custom handler, i.e., that is used in the http&amp;#8217;s</span><br><span class="line">               </span><br><span class="line">* &quot;types &#123; &amp;#8230; &#125;&quot; directive</span><br><span class="line">               </span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">rv = (*cf-&gt;handler)(cf, NULL, cf-&gt;handler_conf);</span><br><span class="line">              </span><br><span class="line">if (rv == NGX_CONF_OK) &#123;</span><br><span class="line">                  </span><br><span class="line">continue;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (rv == NGX_CONF_ERROR) &#123;</span><br><span class="line">                  </span><br><span class="line">goto failed;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_conf_log_error(NGX_LOG_EMERG, cf, 0, rv);</span><br><span class="line"></span><br><span class="line">goto failed;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//没有handler则调用默认解析函数</span><br><span class="line">          </span><br><span class="line">rc = ngx_conf_handler(cf, rc);</span><br><span class="line"></span><br><span class="line">if (rc == NGX_ERROR) &#123;</span><br><span class="line">              </span><br><span class="line">goto failed;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">rc = NGX_ERROR;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line"></span><br><span class="line">return NGX_CONF_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在看ngx_conf_handler之前我们先来看Nginx的配置文件的结构，以及为什么要有cf-&gt;handler。</p>
<p>一般的一个Nginx配置文件是这样子的：</p>
<blockquote>
<p>worker_processes 1;</p>
<p>error_log logs/error.log;</p>
<p>pid logs/nginx.pid;</p>
<p>events {</p>
</blockquote>
<blockquote>
<p>worker_connections 1024;</p>
</blockquote>
<blockquote>
<p>}</p>
<p>http {</p>
</blockquote>
<blockquote>
<p>include mime.types;</p>
</blockquote>
<blockquote>
<p>default_type application/octet-stream;</p>
<p>sendfile on;</p>
<p>keepalive_timeout 65;</p>
<p>#gzip on;</p>
<p>server {</p>
</blockquote>
<blockquote>
<p>listen 80;</p>
</blockquote>
<blockquote>
<p>server_name localhost;</p>
<p>access_log logs/host.access.log main;</p>
<p>location / {</p>
</blockquote>
<blockquote>
<p>root html;</p>
</blockquote>
<blockquote>
<p>index index.html index.htm;</p>
</blockquote>
<blockquote>
<p>}</p>
<p>error_page 500 502 503 504 /50x.html;</p>
</blockquote>
<blockquote>
<p>location = /50x.html {</p>
</blockquote>
<blockquote>
<p>root html;</p>
</blockquote>
<blockquote>
<p>}</p>
</blockquote>
<blockquote>
<p>}</p>
<p>}</p>
</blockquote>
<p>可以看到Nginx的配置文件是分块的，然后event, http都是一个大的core 模块，然后core模块中包含了很多2级模块(epoll/kqeue/proxy..).也就是1级模块中必须包含一个上下文用来保存2级模块的配置。而在HTTP模块中又有一些特殊，那就是HTTP模块中每个指令都可能会有3个作用域，那就是main/server/loc,所以在HTTP的上下文中，必须同时保存这3个上下文。</p>
<p>然后我们来看Nginx中的命令都有那些类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#define NGX_DIRECT_CONF 0x00010000</span><br><span class="line"></span><br><span class="line">#define NGX_MAIN_CONF 0x01000000</span><br><span class="line">  </span><br><span class="line">#define NGX_ANY_CONF 0x0F000000</span><br><span class="line"></span><br><span class="line">#define NGX_EVENT_CONF 0x02000000</span><br><span class="line"></span><br><span class="line">#define NGX_HTTP_MAIN_CONF 0x02000000</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_SRV_CONF 0x04000000</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_LOC_CONF 0x08000000</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_UPS_CONF 0x10000000</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_SIF_CONF 0x20000000</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_LIF_CONF 0x40000000</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_LMT_CONF 0x80000000</span><br><span class="line"></span><br><span class="line">#define NGX_MAIL_MAIN_CONF 0x02000000</span><br><span class="line">  </span><br><span class="line">#define NGX_MAIL_SRV_CONF 0x04000000</span><br></pre></td></tr></table></figure>
<p>Nginx中的参数类型有这么多种其中最有必要区分的就是第一种和第二种，一般来说DIRECT_CONF和MAIN_CONF是同时使用的，也就是有第一个就有第二个。DIRECT_CONF顾名思义，就是说直接存取CONF，也就是说进入命令解析函数的同时，CONF已经创建好了，只需要直接使用就行了(也就是会有create_conf回调）。而Main_conf就是说最顶层的conf，比如HTTP/EVENT/PID等等，可以看到都属属于CORE 模块。而NGX_HTTP_XXX就是所有HTTP模块的子模块.</p>
<p>理解了Nginx配置的基本结构，我们来看ngx_conf_handler,这个函数以前介绍过，这次这里就只关注最核心的部分,下面这部分是遍历命令表，然后找到了对应的命令，然后进行处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//如果设置了type</span><br><span class="line">              </span><br><span class="line">if (!(cmd-&gt;type &amp; NGX_CONF_ANY)) &#123;</span><br><span class="line">  </span><br><span class="line">//首先判断参数个数是否合法</span><br><span class="line">                  </span><br><span class="line">if (cmd-&gt;type &amp; NGX_CONF_FLAG) &#123;</span><br><span class="line"></span><br><span class="line">if (cf-&gt;args-&gt;nelts != 2) &#123;</span><br><span class="line">                          </span><br><span class="line">goto invalid;</span><br><span class="line">                      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; else if (cmd-&gt;type &amp; NGX_CONF_1MORE) &#123;</span><br><span class="line"></span><br><span class="line">if (cf-&gt;args-&gt;nelts &lt; 2) &#123;</span><br><span class="line">                          </span><br><span class="line">goto invalid;</span><br><span class="line">                      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/\* set up the directive&amp;#8217;s configuration context \*/</span><br><span class="line"></span><br><span class="line">conf = NULL;</span><br><span class="line">  </span><br><span class="line">//最核心的地方，</span><br><span class="line">              </span><br><span class="line">if (cmd-&gt;type &amp; NGX_DIRECT_CONF) &#123;</span><br><span class="line">  </span><br><span class="line">我们还记得最开始ctx是包含了所有core模块的conf(create_conf回调),因此这里取出对应的模块conf.</span><br><span class="line">                  </span><br><span class="line">conf = ((void **) cf-&gt;ctx)[ngx_modules[i]-&gt;index];</span><br><span class="line"></span><br><span class="line">&#125; else if (cmd-&gt;type &amp; NGX_MAIN_CONF) &#123;</span><br><span class="line">  </span><br><span class="line">//如果不是DIRECT_CONF并且是MAIN，则说明我们需要在配置中创建自己模块的上下文(也就是需要进入二级模块)</span><br><span class="line">                  </span><br><span class="line">conf = &amp;(((void **) cf-&gt;ctx)[ngx_modules[i]-&gt;index]);</span><br><span class="line"></span><br><span class="line">&#125; else if (cf-&gt;ctx) &#123;</span><br><span class="line">  </span><br><span class="line">//否则进入二级模块处理(后续会详细介绍)。</span><br><span class="line">                  </span><br><span class="line">confp = \*(void \*\*) ((char \*) cf-&gt;ctx + cmd-&gt;conf);</span><br><span class="line"></span><br><span class="line">if (confp) &#123;</span><br><span class="line">                      </span><br><span class="line">conf = confp[ngx_modules[i]-&gt;ctx_index];</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//调用命令的回调函数。</span><br><span class="line">              </span><br><span class="line">rv = cmd-&gt;set(cf, cmd, conf);</span><br><span class="line"></span><br><span class="line">if (rv == NGX_CONF_OK) &#123;</span><br><span class="line">                  </span><br><span class="line">return NGX_OK;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (rv == NGX_CONF_ERROR) &#123;</span><br><span class="line">                  </span><br><span class="line">return NGX_ERROR;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                                 </span><br><span class="line">&quot;\&quot;%s\&quot; directive %s&quot;, name-&gt;data, rv);</span><br><span class="line"></span><br><span class="line">return NGX_ERROR;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中二级模块解析那部分先放一下，首先来看Nginx中带二级模块的一级模块如何解析命令的，来看HTTP模块(event模块基本一样)的解析代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//可以看到没有direct_conf,因为http包含有二级模块。</span><br><span class="line">  </span><br><span class="line">static ngx_command_t ngx_http_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">&#123; ngx_string(&quot;http&quot;),</span><br><span class="line">        </span><br><span class="line">NGX_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,</span><br><span class="line">        </span><br><span class="line">ngx_http_block,</span><br><span class="line">        </span><br><span class="line">0,</span><br><span class="line">        </span><br><span class="line">0,</span><br><span class="line">        </span><br><span class="line">NULL &#125;,</span><br><span class="line"></span><br><span class="line">ngx_null_command</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static char *</span><br><span class="line">  </span><br><span class="line">ngx_http_block(ngx_conf_t \*cf, ngx_command_t \*cmd, void *conf)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">char *rv;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t mi, m, s;</span><br><span class="line">      </span><br><span class="line">ngx_conf_t pcf;</span><br><span class="line">      </span><br><span class="line">ngx_http_module_t *module;</span><br><span class="line">      </span><br><span class="line">ngx_http_conf_ctx_t *ctx;</span><br><span class="line">      </span><br><span class="line">ngx_http_core_loc_conf_t *clcf;</span><br><span class="line">      </span><br><span class="line">ngx_http_core_srv_conf_t **cscfp;</span><br><span class="line">      </span><br><span class="line">ngx_http_core_main_conf_t *cmcf;</span><br><span class="line"></span><br><span class="line">/\* the main http context \*/</span><br><span class="line"></span><br><span class="line">ctx = ngx_pcalloc(cf-&gt;pool, sizeof(ngx_http_conf_ctx_t));</span><br><span class="line">      </span><br><span class="line">if (ctx == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//最核心的地方，可以看到修改了传递进来的conf</span><br><span class="line">      </span><br><span class="line">\*(ngx_http_conf_ctx_t \**) conf = ctx;</span><br><span class="line"></span><br><span class="line">/\* count the number of the http modules and set up their indices \*/</span><br><span class="line"></span><br><span class="line">ngx_http_max_module = 0;</span><br><span class="line">      </span><br><span class="line">for (m = 0; ngx_modules[m]; m++) &#123;</span><br><span class="line">          </span><br><span class="line">if (ngx_modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">              </span><br><span class="line">continue;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//然后保存了对应模块的索引.</span><br><span class="line">          </span><br><span class="line">ngx_modules[m]-&gt;ctx_index = ngx_http_max_module++;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/\* the http main_conf context, it is the same in the all http contexts \*/</span><br><span class="line">  </span><br><span class="line">//创建HTTP对应的conf，因为每个级别(main/ser/loc)都会包含模块的conf.</span><br><span class="line">      </span><br><span class="line">ctx-&gt;main_conf = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                                   </span><br><span class="line">sizeof(void \*) \* ngx_http_max_module);</span><br><span class="line">      </span><br><span class="line">if (ctx-&gt;main_conf == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">       </span><br><span class="line">* the http null srv_conf context, it is used to merge</span><br><span class="line">       </span><br><span class="line">* the server&#123;&#125;s&amp;#8217; srv_conf&amp;#8217;s</span><br><span class="line">       </span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">ctx-&gt;srv_conf = ngx_pcalloc(cf-&gt;pool, sizeof(void \*) \* ngx_http_max_module);</span><br><span class="line">      </span><br><span class="line">if (ctx-&gt;srv_conf == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">       </span><br><span class="line">* the http null loc_conf context, it is used to merge</span><br><span class="line">       </span><br><span class="line">* the server&#123;&#125;s&amp;#8217; loc_conf&amp;#8217;s</span><br><span class="line">       </span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, sizeof(void \*) \* ngx_http_max_module);</span><br><span class="line">      </span><br><span class="line">if (ctx-&gt;loc_conf == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">       </span><br><span class="line">* create the main_conf&amp;#8217;s, the null srv_conf&amp;#8217;s, and the null loc_conf&amp;#8217;s</span><br><span class="line">       </span><br><span class="line">* of the all http modules</span><br><span class="line">       </span><br><span class="line">*/</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">  </span><br><span class="line">//保存当前使用的cf，因为我们只是在解析HTTP时需要改变当前的cf，</span><br><span class="line">      </span><br><span class="line">pcf = *cf;</span><br><span class="line">  </span><br><span class="line">//保存当前模块的上下文</span><br><span class="line">      </span><br><span class="line">cf-&gt;ctx = ctx;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line"></span><br><span class="line">/\* parse inside the http&#123;&#125; block \*/</span><br><span class="line">  </span><br><span class="line">//设置模块类型和命令类型</span><br><span class="line">      </span><br><span class="line">cf-&gt;module_type = NGX_HTTP_MODULE;</span><br><span class="line">      </span><br><span class="line">cf-&gt;cmd_type = NGX_HTTP_MAIN_CONF;</span><br><span class="line">  </span><br><span class="line">//开始解析，这里注意传递进去的文件名是空</span><br><span class="line">      </span><br><span class="line">rv = ngx_conf_parse(cf, NULL);</span><br><span class="line"></span><br><span class="line">if (rv != NGX_CONF_OK) &#123;</span><br><span class="line">          </span><br><span class="line">goto failed;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">       </span><br><span class="line">* init http&#123;&#125; main_conf&amp;#8217;s, merge the server&#123;&#125;s&amp;#8217; srv_conf&amp;#8217;s</span><br><span class="line">       </span><br><span class="line">* and its location&#123;&#125;s&amp;#8217; loc_conf&amp;#8217;s</span><br><span class="line">       </span><br><span class="line">*/</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">/*</span><br><span class="line">       </span><br><span class="line">* http&#123;&#125;&amp;#8217;s cf-&gt;ctx was needed while the configuration merging</span><br><span class="line">       </span><br><span class="line">* and in postconfiguration process</span><br><span class="line">       </span><br><span class="line">*/</span><br><span class="line">  </span><br><span class="line">//回复cf</span><br><span class="line">      </span><br><span class="line">*cf = pcf;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line"></span><br><span class="line">return NGX_CONF_OK;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line"></span><br><span class="line">*cf = pcf;</span><br><span class="line"></span><br><span class="line">return rv;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有个非常关键的地方，那就是在每个级别都会保存对应的ctx(main/ser/loc)，怎么说呢，就是在解析HTTP main中创建了3个ctx(main/srv/loc),而在HTTP srv block中将会创建2个ctx(main/srv/loc),或许会问重复了怎么办？重复了，那就需要merge了。比如一个命令(srv_offset)在HTTP main中有一个，那么Nginx将会把它放入到HTTP main的ctx的srv ctx中，然后server block也有一个，那么Nginx会继续把它放到Server ctx的 srv_conf中，最后merge他们。</p>
<p>因此我们来看server这个命令的解析:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">&#123; ngx_string(&quot;server&quot;),</span><br><span class="line">        </span><br><span class="line">NGX_HTTP_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_MULTI|NGX_CONF_NOARGS,</span><br><span class="line">        </span><br><span class="line">ngx_http_core_server,</span><br><span class="line">        </span><br><span class="line">0,</span><br><span class="line">        </span><br><span class="line">0,</span><br><span class="line">        </span><br><span class="line">NULL &#125;,</span><br><span class="line"></span><br><span class="line">static char *</span><br><span class="line">  </span><br><span class="line">ngx_http_core_server(ngx_conf_t \*cf, ngx_command_t \*cmd, void *dummy)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">char *rv;</span><br><span class="line">      </span><br><span class="line">void *mconf;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t i;</span><br><span class="line">      </span><br><span class="line">ngx_conf_t pcf;</span><br><span class="line">      </span><br><span class="line">ngx_http_module_t *module;</span><br><span class="line">      </span><br><span class="line">struct sockaddr_in *sin;</span><br><span class="line">      </span><br><span class="line">ngx_http_conf_ctx_t \*ctx, \*http_ctx;</span><br><span class="line">      </span><br><span class="line">ngx_http_listen_opt_t lsopt;</span><br><span class="line">      </span><br><span class="line">ngx_http_core_srv_conf_t \*cscf, \**cscfp;</span><br><span class="line">      </span><br><span class="line">ngx_http_core_main_conf_t *cmcf;</span><br><span class="line"></span><br><span class="line">ctx = ngx_pcalloc(cf-&gt;pool, sizeof(ngx_http_conf_ctx_t));</span><br><span class="line">      </span><br><span class="line">if (ctx == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http_ctx = cf-&gt;ctx;</span><br><span class="line">  </span><br><span class="line">//main conf不变</span><br><span class="line">      </span><br><span class="line">ctx-&gt;main_conf = http_ctx-&gt;main_conf;</span><br><span class="line"></span><br><span class="line">/\* the server&#123;&#125;&amp;#8217;s srv_conf \*/</span><br><span class="line">  </span><br><span class="line">//创建新的srv和loc conf.</span><br><span class="line">      </span><br><span class="line">ctx-&gt;srv_conf = ngx_pcalloc(cf-&gt;pool, sizeof(void \*) \* ngx_http_max_module);</span><br><span class="line">      </span><br><span class="line">if (ctx-&gt;srv_conf == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/\* the server&#123;&#125;&amp;#8217;s loc_conf \*/</span><br><span class="line"></span><br><span class="line">ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, sizeof(void \*) \* ngx_http_max_module);</span><br><span class="line">      </span><br><span class="line">if (ctx-&gt;loc_conf == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line"></span><br><span class="line">/\* the server configuration context \*/</span><br><span class="line"></span><br><span class="line">cscf = ctx-&gt;srv_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">      </span><br><span class="line">cscf-&gt;ctx = ctx;</span><br><span class="line"></span><br><span class="line">cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">  </span><br><span class="line">//保存所有的servers，可以看到是保存在main中的。这样子最后在HTTP main中就可以取到这个srv conf.</span><br><span class="line">      </span><br><span class="line">cscfp = ngx_array_push(&amp;cmcf-&gt;servers);</span><br><span class="line">      </span><br><span class="line">if (cscfp == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">*cscfp = cscf;</span><br><span class="line"></span><br><span class="line">/\* parse inside server&#123;&#125; \*/</span><br><span class="line">  </span><br><span class="line">//解析，可以看到设置type为srv_conf.</span><br><span class="line">      </span><br><span class="line">pcf = *cf;</span><br><span class="line">      </span><br><span class="line">cf-&gt;ctx = ctx;</span><br><span class="line">      </span><br><span class="line">cf-&gt;cmd_type = NGX_HTTP_SRV_CONF;</span><br><span class="line"></span><br><span class="line">rv = ngx_conf_parse(cf, NULL);</span><br><span class="line">  </span><br><span class="line">//恢复cf.</span><br><span class="line">      </span><br><span class="line">*cf = pcf;</span><br><span class="line"></span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return rv;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>了解了这些，我们来看最上面的那段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">struct ngx_command_s &#123;</span><br><span class="line">      </span><br><span class="line">ngx_str_t name;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t type;</span><br><span class="line">      </span><br><span class="line">char \*(\*set)(ngx_conf_t \*cf, ngx_command_t \*cmd, void *conf);</span><br><span class="line">  </span><br><span class="line">//conf就是对应的上下文偏移.比如NGX_HTTP_LOC_CONF_OFFSET</span><br><span class="line">      </span><br><span class="line">ngx_uint_t conf;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t offset;</span><br><span class="line">      </span><br><span class="line">void *post;</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line">              </span><br><span class="line">else if (cf-&gt;ctx) &#123;</span><br><span class="line">  </span><br><span class="line">//取得对应的1级模块的二级上下文(HTTP的 srv_offset)</span><br><span class="line">                  </span><br><span class="line">confp = \*(void \*\*) ((char \*) cf-&gt;ctx + cmd-&gt;conf);</span><br><span class="line"></span><br><span class="line">if (confp) &#123;</span><br><span class="line">  </span><br><span class="line">//然后取出对应的模块conf.</span><br><span class="line">                      </span><br><span class="line">conf = confp[ngx_modules[i]-&gt;ctx_index];</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来看一些简单的命令是如何使用和配置的。在看之前先来看几个核心的结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">typedef struct &#123;</span><br><span class="line">      </span><br><span class="line">void **main_conf;</span><br><span class="line">      </span><br><span class="line">void **srv_conf;</span><br><span class="line">      </span><br><span class="line">void **loc_conf;</span><br><span class="line">  </span><br><span class="line">&#125; ngx_http_conf_ctx_t;</span><br><span class="line"></span><br><span class="line">//下面这些就是放到ngx_command_t的conf域，可以看到就是对应conf的偏移.</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_MAIN_CONF_OFFSET offsetof(ngx_http_conf_ctx_t, main_conf)</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_SRV_CONF_OFFSET offsetof(ngx_http_conf_ctx_t, srv_conf)</span><br><span class="line">  </span><br><span class="line">#define NGX_HTTP_LOC_CONF_OFFSET offsetof(ngx_http_conf_ctx_t, loc_conf)</span><br><span class="line"></span><br><span class="line">//下面就是如何来取模块的配置</span><br><span class="line">  </span><br><span class="line">#define ngx_http_get_module_main_conf(r, module) \</span><br><span class="line">      </span><br><span class="line">(r)-&gt;main_conf[module.ctx_index]</span><br><span class="line">  </span><br><span class="line">#define ngx_http_get_module_srv_conf(r, module) (r)-&gt;srv_conf[module.ctx_index]</span><br><span class="line">  </span><br><span class="line">#define ngx_http_get_module_loc_conf(r, module) (r)-&gt;loc_conf[module.ctx_index]</span><br><span class="line"></span><br><span class="line">#define ngx_http_conf_get_module_main_conf(cf, module) \</span><br><span class="line">      </span><br><span class="line">((ngx_http_conf_ctx_t *) cf-&gt;ctx)-&gt;main_conf[module.ctx_index]</span><br><span class="line">  </span><br><span class="line">#define ngx_http_conf_get_module_srv_conf(cf, module) \</span><br><span class="line">      </span><br><span class="line">((ngx_http_conf_ctx_t *) cf-&gt;ctx)-&gt;srv_conf[module.ctx_index]</span><br><span class="line">  </span><br><span class="line">#define ngx_http_conf_get_module_loc_conf(cf, module) \</span><br><span class="line">      </span><br><span class="line">((ngx_http_conf_ctx_t *) cf-&gt;ctx)-&gt;loc_conf[module.ctx_index]</span><br><span class="line"></span><br><span class="line">#define ngx_http_cycle_get_module_main_conf(cycle, module) \</span><br><span class="line">      </span><br><span class="line">(cycle-&gt;conf_ctx[ngx_http_module.index] ? \</span><br><span class="line">          </span><br><span class="line">((ngx_http_conf_ctx_t *) cycle-&gt;conf_ctx[ngx_http_module.index]) \</span><br><span class="line">              </span><br><span class="line">-&gt;main_conf[module.ctx_index]: \</span><br><span class="line">          </span><br><span class="line">NULL)</span><br><span class="line"></span><br><span class="line">#define ngx_get_conf(conf_ctx, module) conf_ctx[module.index]</span><br></pre></td></tr></table></figure>
<p>来看几个典型的配置命令。</p>
<p>首先是env，它是一个 DIRECT_CONF命令.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//可以看到有create_conf函数</span><br><span class="line">  </span><br><span class="line">static ngx_core_module_t ngx_core_module_ctx = &#123;</span><br><span class="line">      </span><br><span class="line">ngx_string(&quot;core&quot;),</span><br><span class="line">      </span><br><span class="line">ngx_core_module_create_conf,</span><br><span class="line">      </span><br><span class="line">ngx_core_module_init_conf</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">&#123; ngx_string(&quot;env&quot;),</span><br><span class="line">        </span><br><span class="line">NGX_MAIN_CONF|NGX_DIRECT_CONF|NGX_CONF_TAKE1,</span><br><span class="line">        </span><br><span class="line">ngx_set_env,</span><br><span class="line">        </span><br><span class="line">0,</span><br><span class="line">        </span><br><span class="line">0,</span><br><span class="line">        </span><br><span class="line">NULL &#125;,</span><br><span class="line"></span><br><span class="line">static char *</span><br><span class="line">  </span><br><span class="line">ngx_set_env(ngx_conf_t \*cf, ngx_command_t \*cmd, void *conf)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">//直接读取到然后使用</span><br><span class="line">      </span><br><span class="line">ngx_core_conf_t *ccf = conf;</span><br><span class="line"></span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">return NGX_CONF_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是http的root命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">&#123; ngx_string(&quot;root&quot;),</span><br><span class="line">        </span><br><span class="line">NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF</span><br><span class="line">                          </span><br><span class="line">|NGX_CONF_TAKE1,</span><br><span class="line">        </span><br><span class="line">ngx_http_core_root,</span><br><span class="line">        </span><br><span class="line">NGX_HTTP_LOC_CONF_OFFSET,</span><br><span class="line">        </span><br><span class="line">0,</span><br><span class="line">        </span><br><span class="line">NULL &#125;,</span><br><span class="line"></span><br><span class="line">static char *</span><br><span class="line">  </span><br><span class="line">ngx_http_core_root(ngx_conf_t \*cf, ngx_command_t \*cmd, void *conf)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">//也是直接使用(通过传递进入的偏移NGX_HTTP_LOC_CONF_OFFSET)</span><br><span class="line">      </span><br><span class="line">ngx_http_core_loc_conf_t *clcf = conf;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line"></span><br><span class="line">return NGX_CONF_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后来看一下为什么要有四级指针，这个其实是和模块级别相关的，如果只有一级模块，那么只需要2级指针就够了，可是现在还有2级模块，那么每个1级模块的2级指针里面必须得扩展指针以保存本级别模块的上下文，那么自然就是4级指针了，详细可以看看event模块，它里面比较清晰。</p>
</div><div class="tags"><a href="/tags/opensource/">opensource</a><a href="/tags/nginx/">nginx</a><a href="/tags/server/">server</a></div><div class="post-nav"><a class="pre" href="/2012/05/19/mochiweb-source-code-analysis-(1).html">mochiweb源码分析(一)</a><a class="next" href="/2012/04/08/source-code-analysis-of-hotwheels.html">hotwheels源码剖析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/">SPDY</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/协议/">协议</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/server/">server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/lua/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/">server</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/源码阅读/">源码阅读</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/语言规范/">语言规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/rocksdb/" style="font-size: 15px;">rocksdb</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/server/" style="font-size: 15px;">server</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/aio/" style="font-size: 15px;">aio</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/process/" style="font-size: 15px;">process</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a> <a href="/tags/google/" style="font-size: 15px;">google</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/路由/" style="font-size: 15px;">路由</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TFO/" style="font-size: 15px;">TFO</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/语言规范/" style="font-size: 15px;">语言规范</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/spdy/" style="font-size: 15px;">spdy</a> <a href="/tags/kenel/" style="font-size: 15px;">kenel</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/sever/" style="font-size: 15px;">sever</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/rfs/" style="font-size: 15px;">rfs</a> <a href="/tags/congest/" style="font-size: 15px;">congest</a> <a href="/tags/web-server/" style="font-size: 15px;">web server</a> <a href="/tags/tcp-cork/" style="font-size: 15px;">tcp_cork</a> <a href="/tags/服务器设计/" style="font-size: 15px;">服务器设计</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/pipeline/" style="font-size: 15px;">pipeline</a> <a href="/tags/server，mm/" style="font-size: 15px;">server，mm</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/mochiweb/" style="font-size: 15px;">mochiweb</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/loadbalance/" style="font-size: 15px;">loadbalance</a> <a href="/tags/InnoDB/" style="font-size: 15px;">InnoDB</a> <a href="/tags/glibc/" style="font-size: 15px;">glibc</a> <a href="/tags/systemcall/" style="font-size: 15px;">systemcall</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/gro/" style="font-size: 15px;">gro</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/design-and-implementation-of-mtr-(mini-transaction).html">MTR(mini-transaction)设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/design-and-implementation-of-linkbuf-in-innodb.html">InnoDB中LinkBuf设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/innodb-tablespace-source-code-analysis.html">InnoDB tablespace源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/.html">MySQL · RocksDB · 数据的读取(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/mysql-rocksdb.-data-reading-(i).html">MySQL · RocksDB · 数据的读取(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/mysql-rocksdb-level-compact-analysis.html">MySQL · RocksDB · Level Compact 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/07/mysql-rocksdb-memtable-flush-analysis.html">MySQL · RocksDB · Memtable flush分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/writing-of-mysql.-rocksdb.-memtable.html">MySQL · RocksDB ·  MemTable的写入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/implementation-of-mysql-rocksdb-writing-logic.html">MySQL · RocksDB ·  写入逻辑的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/06/introduction-to-mysql-rocksdb-column-family.html">MySQL · RocksDB · Column Family介绍</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">pagefault.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
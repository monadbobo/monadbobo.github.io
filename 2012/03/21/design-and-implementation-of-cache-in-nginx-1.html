<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>nginx中cache的设计和实现(一) | pagefault</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">nginx中cache的设计和实现(一)</h1><a id="logo" href="/.">pagefault</a><p class="description">但行好事 莫問前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nginx中cache的设计和实现(一)</h1><div class="post-meta">Mar 21, 2012<span> | </span><span class="category"><a href="/categories/nginx/">nginx</a><a href="/categories/nginx/server/">server</a></span></div><div class="post-content"><p>Nginx的cache实现比较简单，没有使用内存，全部都是使用文件来对后端的response进行cache，因此nginx相比varnish以及squid之类的专门做cache的server，可能效果不会那么好。特别如果cache内容比较大的话。不过还有一种折衷的处理，那就是挂载一个内存盘，然后让nginx cache到这个盘。</p>
<p>我这里的看的代码是1.1.17.</p>
<p>首先来看Nginx中如何开启cache，http cache主要是应用在upstream中的，因此upstream对应的两个命令来启用cache，一个是xxx_cache_path(比如proxy_cache_path)，它主要是用来创建管理cache的共享内存数据结构(红黑树和队列).一个是xxx_cache,它主要是使用前面创建的zone。</p>
<p>先来看第一个命令，xxx_cache_path,它会调用ngx_http_file_cache_set_slot函数，在看这个函数之前，先来看ngx_http_file_cache_t这个数据结构，它主要用来管理所有的cache文件，它本身不保存cache，只是保存管理cache的数据结构。每一个xxx_cache_path都会创建一个ngx_http_file_cache_t.</p>
<a id="more"></a>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">typedef struct &#123;</span><br><span class="line">      </span><br><span class="line">ngx_rbtree_t rbtree;</span><br><span class="line">      </span><br><span class="line">ngx_rbtree_node_t sentinel;</span><br><span class="line">      </span><br><span class="line">ngx_queue_t queue;</span><br><span class="line">  </span><br><span class="line">//cold表示这个cache是否已经被loader进程load过了</span><br><span class="line">      </span><br><span class="line">ngx_atomic_t cold;</span><br><span class="line">  </span><br><span class="line">//那个进程正在load这个cache</span><br><span class="line">      </span><br><span class="line">ngx_atomic_t loading;</span><br><span class="line">  </span><br><span class="line">//文件大小</span><br><span class="line">      </span><br><span class="line">off_t size;</span><br><span class="line">  </span><br><span class="line">&#125; ngx_http_file_cache_sh_t;</span><br><span class="line"></span><br><span class="line">struct ngx_http_file_cache_s &#123;</span><br><span class="line">      </span><br><span class="line">ngx_http_file_cache_sh_t *sh;</span><br><span class="line">      </span><br><span class="line">ngx_slab_pool_t *shpool;</span><br><span class="line">  </span><br><span class="line">//cache的目录</span><br><span class="line">      </span><br><span class="line">ngx_path_t *path;</span><br><span class="line">  </span><br><span class="line">//当前的path下的所有cache文件的最大值</span><br><span class="line">      </span><br><span class="line">off_t max_size;</span><br><span class="line">      </span><br><span class="line">size_t bsize;</span><br><span class="line">  </span><br><span class="line">//如果多久不使用就被删除</span><br><span class="line">      </span><br><span class="line">time_t inactive;</span><br><span class="line">  </span><br><span class="line">//当前有多少个cache文件(超过loader_files之后会被清0)</span><br><span class="line">      </span><br><span class="line">ngx_uint_t files;</span><br><span class="line">  </span><br><span class="line">//这个值也就是一个阈值，当load的文件个数大于这个值之后，load进程会短暂的休眠(时间位loader_sleep)</span><br><span class="line">      </span><br><span class="line">ngx_uint_t loader_files;</span><br><span class="line">  </span><br><span class="line">//最后被manage或者loader访问的时间</span><br><span class="line">      </span><br><span class="line">ngx_msec_t last;</span><br><span class="line">  </span><br><span class="line">//和上面的loader_files配合使用，当文件个数大于loader_files，就会休眠</span><br><span class="line">      </span><br><span class="line">ngx_msec_t loader_sleep;</span><br><span class="line">  </span><br><span class="line">//配合上面的last，也就是loader遍历的休眠间隔。</span><br><span class="line">      </span><br><span class="line">ngx_msec_t loader_threshold;</span><br><span class="line">  </span><br><span class="line">//共享内存的地址</span><br><span class="line">      </span><br><span class="line">ngx_shm_zone_t *shm_zone;</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后这里有一个很关键的结构就是ngx_path_t,它保存了当前的cache的一些信息，以及对应的cache管理回调函数manger和loader.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">typedef struct &#123;</span><br><span class="line">  </span><br><span class="line">//cache名字</span><br><span class="line">      </span><br><span class="line">ngx_str_t name;</span><br><span class="line">      </span><br><span class="line">size_t len;</span><br><span class="line">      </span><br><span class="line">size_t level[3];</span><br><span class="line">  </span><br><span class="line">//对应的回调，以及回调数据</span><br><span class="line">      </span><br><span class="line">ngx_path_manager_pt manager;</span><br><span class="line">      </span><br><span class="line">ngx_path_loader_pt loader;</span><br><span class="line">      </span><br><span class="line">void *data;</span><br><span class="line"></span><br><span class="line">u_char *conf_file;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t line;</span><br><span class="line">  </span><br><span class="line">&#125; ngx_path_t;</span><br></pre></td></tr></table></figure>

<p>然后我们来看ngx_http_file_cache_set_slot函数，这个函数中可以看到上面的结构都是如何被初始化的。函数比较长，我们来看关键的部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">ngx_http_file_cache_t *cache;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line">  </span><br><span class="line">//初始化cache对象，这两个回调后续会详细分析</span><br><span class="line">      </span><br><span class="line">cache-&gt;path-&gt;manager = ngx_http_file_cache_manager;</span><br><span class="line">      </span><br><span class="line">cache-&gt;path-&gt;loader = ngx_http_file_cache_loader;</span><br><span class="line">      </span><br><span class="line">cache-&gt;path-&gt;data = cache;</span><br><span class="line">      </span><br><span class="line">cache-&gt;path-&gt;conf_file = cf-&gt;conf_file-&gt;file.name.data;</span><br><span class="line">      </span><br><span class="line">cache-&gt;path-&gt;line = cf-&gt;conf_file-&gt;line;</span><br><span class="line">  </span><br><span class="line">//初始化这几个阈值</span><br><span class="line">      </span><br><span class="line">cache-&gt;loader_files = loader_files;</span><br><span class="line">      </span><br><span class="line">cache-&gt;loader_sleep = (ngx_msec_t) loader_sleep;</span><br><span class="line">      </span><br><span class="line">cache-&gt;loader_threshold = (ngx_msec_t) loader_threshold;</span><br><span class="line">  </span><br><span class="line">//将path添加到全局的路径管理中</span><br><span class="line">      </span><br><span class="line">if (ngx_add_path(cf, &amp;cache-&gt;path) != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//创建共享内存</span><br><span class="line">      </span><br><span class="line">cache-&gt;shm_zone = ngx_shared_memory_add(cf, &amp;name, size, cmd-&gt;post);</span><br><span class="line">      </span><br><span class="line">if (cache-&gt;shm_zone == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (cache-&gt;shm_zone-&gt;data) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,</span><br><span class="line">                             </span><br><span class="line">&quot;duplicate zone \&quot;%V\&quot;&quot;, &amp;name);</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//设置初始化函数</span><br><span class="line">      </span><br><span class="line">cache-&gt;shm_zone-&gt;init = ngx_http_file_cache_init;</span><br><span class="line">      </span><br><span class="line">cache-&gt;shm_zone-&gt;data = cache;</span><br><span class="line">  </span><br><span class="line">//设置cache</span><br><span class="line">      </span><br><span class="line">cache-&gt;inactive = inactive;</span><br><span class="line">      </span><br><span class="line">cache-&gt;max_size = max_size;</span><br></pre></td></tr></table></figure>

<p>然后是每个upstream模块的xxx_cache命令，这个命令对应xxx_cache函数，我们这里就看看ngx_http_fastcgi_cache函数。这个函数更简单,就是简单的查找出上面创建的共享内存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static char *</span><br><span class="line">  </span><br><span class="line">ngx_http_fastcgi_cache(ngx_conf_t \*cf, ngx_command_t \*cmd, void *conf)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">  </span><br><span class="line">//查找出共享内存</span><br><span class="line">      </span><br><span class="line">flcf-&gt;upstream.cache = ngx_shared_memory_add(cf, &amp;value[1], 0,</span><br><span class="line">                                                   </span><br><span class="line">&amp;ngx_http_fastcgi_module);</span><br><span class="line">      </span><br><span class="line">if (flcf-&gt;upstream.cache == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return NGX_CONF_ERROR;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return NGX_CONF_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后来看cache系统的启动。当配置解析完毕之后就会进入进程的初始化部分也就是ngx_master_process_cycle 这个函数，而在这个函数中将会启动nginx的worker。 并且会启动对应的cache manger和cache loader，也就是说cache manger和cache loader是一对子进程，并且独立于worker。</p>
<p>cache manger的作用是用来定时删除无用的cache文件(引用计数为0),一般来说只有manger会删除无用的cache(特殊情况，比如在loader中分配共享内存失败可能会强制删除一些cache， 或者说 loader的时候遇到一些特殊文件).</p>
<p>cache loader的的主要作用是定时遍历cache目录，然后加载一些没有被加载的文件(比如nginx重启后，也就是上次遗留的文件),或者说将cache文件重新插入(因为删除是使用LRU算法),后续能够看到代码细节。</p>
<p>接下来就来看代码，首先在中 ngx_master_process_cycle会调用ngx_start_cache_manager_processes来启动cache子系统，我们来看这个函数的片段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">//启动manger子进程</span><br><span class="line">      </span><br><span class="line">ngx_spawn_process(cycle, ngx_cache_manager_process_cycle,</span><br><span class="line">                        </span><br><span class="line">&amp;ngx_cache_manager_ctx, &quot;cache manager process&quot;,</span><br><span class="line">                        </span><br><span class="line">respawn ? NGX_PROCESS_JUST_RESPAWN : NGX_PROCESS_RESPAWN);</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">  </span><br><span class="line">//启动loader子进程</span><br><span class="line">      </span><br><span class="line">ngx_spawn_process(cycle, ngx_cache_manager_process_cycle,</span><br><span class="line">                        </span><br><span class="line">&amp;ngx_cache_loader_ctx, &quot;cache loader process&quot;,</span><br><span class="line">                        </span><br><span class="line">respawn ? NGX_PROCESS_JUST_SPAWN : NGX_PROCESS_NORESPAWN);</span><br></pre></td></tr></table></figure>

<p>从上面可以看到会fork两个子进程，然后子进程的回调是ngx_cache_manager_process_cycle这个函数，这个函数比较简单，就是设置定时器:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static void</span><br><span class="line">  </span><br><span class="line">ngx_cache_manager_process_cycle(ngx_cycle_t \*cycle, void \*data)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_cache_manager_ctx_t *ctx = data;</span><br><span class="line"></span><br><span class="line">void *ident[4];</span><br><span class="line">      </span><br><span class="line">ngx_event_t ev;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">      </span><br><span class="line">ngx_memzero(&amp;ev, sizeof(ngx_event_t));</span><br><span class="line">  </span><br><span class="line">//最核心的在这里了设置传递进来的ctx-&gt;handler为定时器回调</span><br><span class="line">      </span><br><span class="line">ev.handler = ctx-&gt;handler;</span><br><span class="line">      </span><br><span class="line">ev.data = ident;</span><br><span class="line">      </span><br><span class="line">ev.log = cycle-&gt;log;</span><br><span class="line">      </span><br><span class="line">ident[3] = (void *) -1;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">  </span><br><span class="line">//添加定时器</span><br><span class="line">      </span><br><span class="line">ngx_add_timer(&amp;ev, ctx-&gt;delay);</span><br><span class="line">  </span><br><span class="line">//进入事件循环</span><br><span class="line">      </span><br><span class="line">for ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">if (ngx_terminate || ngx_quit) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;log, 0, &quot;exiting&quot;);</span><br><span class="line">              </span><br><span class="line">exit(0);</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (ngx_reopen) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_reopen = 0;</span><br><span class="line">              </span><br><span class="line">ngx_log_error(NGX_LOG_NOTICE, cycle-&gt;log, 0, &quot;reopening logs&quot;);</span><br><span class="line">              </span><br><span class="line">ngx_reopen_files(cycle, -1);</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_process_events_and_timers(cycle);</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的函数可以看到定时器的回调会设置为传递给ngx_cache_manager_process_cycle函数的data，而这个data是什么呢，就是上面ngx_start_cache_manager_processes函数中传递给spawn 的第三个参数，这里由于是两个子进程，所以有两个结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static ngx_cache_manager_ctx_t ngx_cache_manager_ctx = &#123;</span><br><span class="line">      </span><br><span class="line">ngx_cache_manager_process_handler, &quot;cache manager process&quot;, 0</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static ngx_cache_manager_ctx_t ngx_cache_loader_ctx = &#123;</span><br><span class="line">      </span><br><span class="line">ngx_cache_loader_process_handler, &quot;cache loader process&quot;, 60000</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>也就是说manger 和 loader的定时器会分别调用ngx_cache_manager_process_handler和ngx_cache_loader_process_handler，不过可以看到manager的定时器初始时间是0，而loader是60000毫秒。</p>
<p>在看这两个handler之前，先看一个结构就是ngx_http_file_cache_node_t，一个cache文件对应一个node，这个node中主要保存了cache 的key和uniq， uniq主要是关联文件，而key是用于红黑树。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">typedef struct &#123;</span><br><span class="line">  </span><br><span class="line">//红黑树和queue结构</span><br><span class="line">      </span><br><span class="line">ngx_rbtree_node_t node;</span><br><span class="line">      </span><br><span class="line">ngx_queue_t queue;</span><br><span class="line">  </span><br><span class="line">//cache key</span><br><span class="line">      </span><br><span class="line">u_char key[NGX_HTTP_CACHE_KEY_LEN</span><br><span class="line">                                           </span><br><span class="line">&amp;#8211; sizeof(ngx_rbtree_key_t)];</span><br><span class="line">  </span><br><span class="line">//引用计数</span><br><span class="line">      </span><br><span class="line">unsigned count:20;</span><br><span class="line">  </span><br><span class="line">//多少请求在使用</span><br><span class="line">      </span><br><span class="line">unsigned uses:10;</span><br><span class="line">      </span><br><span class="line">unsigned valid_msec:10;</span><br><span class="line">  </span><br><span class="line">//cache的状态</span><br><span class="line">      </span><br><span class="line">unsigned error:10;</span><br><span class="line">  </span><br><span class="line">//是否存在对应的cache文件</span><br><span class="line">      </span><br><span class="line">unsigned exists:1;</span><br><span class="line">  </span><br><span class="line">//是否正在更新</span><br><span class="line">      </span><br><span class="line">unsigned updating:1;</span><br><span class="line">  </span><br><span class="line">//是否正在删除</span><br><span class="line">      </span><br><span class="line">unsigned deleting:1;</span><br><span class="line">                                       </span><br><span class="line">/\* 11 unused bits \*/</span><br><span class="line">  </span><br><span class="line">//文件的uniq</span><br><span class="line">      </span><br><span class="line">ngx_file_uniq_t uniq;</span><br><span class="line">  </span><br><span class="line">//cache失效时间</span><br><span class="line">      </span><br><span class="line">time_t expire;、</span><br><span class="line">  </span><br><span class="line">//比如cache control中的max-age。</span><br><span class="line">      </span><br><span class="line">time_t valid_sec;</span><br><span class="line">  </span><br><span class="line">//其实应该是body大小</span><br><span class="line">      </span><br><span class="line">size_t body_start;</span><br><span class="line">  </span><br><span class="line">//文件大小</span><br><span class="line">      </span><br><span class="line">off_t fs_size;</span><br><span class="line">  </span><br><span class="line">&#125; ngx_http_file_cache_node_t;</span><br></pre></td></tr></table></figure>

<p>然后先来看manager的handler。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static void</span><br><span class="line">  </span><br><span class="line">ngx_cache_manager_process_handler(ngx_event_t *ev)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">time_t next, n;</span><br><span class="line">      </span><br><span class="line">ngx_uint_t i;</span><br><span class="line">      </span><br><span class="line">ngx_path_t **path;</span><br><span class="line"></span><br><span class="line">next = 60 * 60;</span><br><span class="line"></span><br><span class="line">path = ngx_cycle-&gt;pathes.elts;</span><br><span class="line">  </span><br><span class="line">//遍历所有的cache目录</span><br><span class="line">      </span><br><span class="line">for (i = 0; i &lt; ngx_cycle-&gt;pathes.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">if (path[i]-&gt;manager) &#123;</span><br><span class="line">  </span><br><span class="line">//调用manger回调</span><br><span class="line">              </span><br><span class="line">n = path[i]-&gt;manager(path[i]-&gt;data);</span><br><span class="line">  </span><br><span class="line">//取得下一次的定时器的时间，可以看到是取n和next的最小值</span><br><span class="line">              </span><br><span class="line">next = (n &lt;= next) ? n : next;</span><br><span class="line"></span><br><span class="line">ngx_time_update();</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (next == 0) &#123;</span><br><span class="line">          </span><br><span class="line">next = 1;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_add_timer(ev, next * 1000);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面最核心的就是path[i]-&gt;manager,而这个回调是在一开始介绍的ngx_http_file_cache_set_slot中设置的，它设置manager回调为ngx_http_file_cache_manager，我们就来看这个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static time_t</span><br><span class="line">  </span><br><span class="line">ngx_http_file_cache_manager(void *data)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_http_file_cache_t *cache = data;</span><br><span class="line"></span><br><span class="line">off_t size;</span><br><span class="line">      </span><br><span class="line">time_t next, wait;</span><br><span class="line">  </span><br><span class="line">//如果有超时的cache，就超时对应的cache</span><br><span class="line">      </span><br><span class="line">next = ngx_http_file_cache_expire(cache);</span><br><span class="line">  </span><br><span class="line">//最后访问时间</span><br><span class="line">      </span><br><span class="line">cache-&gt;last = ngx_current_msec;</span><br><span class="line">      </span><br><span class="line">cache-&gt;files = 0;</span><br><span class="line"></span><br><span class="line">for ( ;; ) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">size = cache-&gt;sh-&gt;size;</span><br><span class="line"></span><br><span class="line">ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_HTTP, ngx_cycle-&gt;log, 0,</span><br><span class="line">                         </span><br><span class="line">&quot;http file cache size: %O&quot;, size);</span><br><span class="line">  </span><br><span class="line">//如果没有超过最大的大小限制，则直接返回。</span><br><span class="line">          </span><br><span class="line">if (size &lt; cache-&gt;max_size) &#123;</span><br><span class="line">              </span><br><span class="line">return next;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//否则遍历所有的cache文件，然后删除过期的cache.</span><br><span class="line">          </span><br><span class="line">wait = ngx_http_file_cache_forced_expire(cache);</span><br><span class="line"></span><br><span class="line">if (wait &gt; 0) &#123;</span><br><span class="line">              </span><br><span class="line">return wait;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (ngx_quit || ngx_terminate) &#123;</span><br><span class="line">              </span><br><span class="line">return next;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的函数中主要调用了两个函数，一个是ngx_http_file_cache_expire,一个是ngx_http_file_cache_forced_expire，他们有什么区别呢，主要区别是这样子，前一个只有过期的cache才会去尝试删除它(引用计数为0),而后一个不管有没有过期，只要引用计数为0，就会去清理。来详细看这两个函数的实现。</p>
<p>首先是ngx_http_file_cache_expire，这里注意nginx使用了LRU，也就是队列最尾端保存的是最长时间没有被使用的,并且这个函数返回的就是一个wait值，这个值的计算不知道为什么nginx会设置为10ms，我觉得这个值设置为可调或许更好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static time_t</span><br><span class="line">  </span><br><span class="line">ngx_http_file_cache_expire(ngx_http_file_cache_t *cache)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line"></span><br><span class="line">now = ngx_time();</span><br><span class="line"></span><br><span class="line">ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">for ( ;; ) &#123;</span><br><span class="line">  </span><br><span class="line">//如果cache队列为空，则直接退出返回</span><br><span class="line">          </span><br><span class="line">if (ngx_queue_empty(&amp;cache-&gt;sh-&gt;queue)) &#123;</span><br><span class="line">              </span><br><span class="line">wait = 10;</span><br><span class="line">              </span><br><span class="line">break;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//从最后一个开始</span><br><span class="line">          </span><br><span class="line">q = ngx_queue_last(&amp;cache-&gt;sh-&gt;queue);</span><br><span class="line"></span><br><span class="line">fcn = ngx_queue_data(q, ngx_http_file_cache_node_t, queue);</span><br><span class="line"></span><br><span class="line">wait = fcn-&gt;expire &amp;#8211; now;</span><br><span class="line">  </span><br><span class="line">//如果没有超时，则退出循环</span><br><span class="line">          </span><br><span class="line">if (wait &gt; 0) &#123;</span><br><span class="line">              </span><br><span class="line">wait = wait &gt; 10 ? 10 : wait;</span><br><span class="line">              </span><br><span class="line">break;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;</span><br><span class="line">  </span><br><span class="line">//如果引用计数为0，则删除这个cache节点</span><br><span class="line">          </span><br><span class="line">if (fcn-&gt;count == 0) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_file_cache_delete(cache, q, name);</span><br><span class="line">              </span><br><span class="line">continue;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果当前节点正在删除，则退出循环</span><br><span class="line">          </span><br><span class="line">if (fcn-&gt;deleting) &#123;</span><br><span class="line">              </span><br><span class="line">wait = 1;</span><br><span class="line">              </span><br><span class="line">break;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p = ngx_hex_dump(key, (u_char *) &amp;fcn-&gt;node.key,</span><br><span class="line">                           </span><br><span class="line">sizeof(ngx_rbtree_key_t));</span><br><span class="line">          </span><br><span class="line">len = NGX_HTTP_CACHE_KEY_LEN &amp;#8211; sizeof(ngx_rbtree_key_t);</span><br><span class="line">          </span><br><span class="line">(void) ngx_hex_dump(p, fcn-&gt;key, len);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">           </span><br><span class="line">* abnormally exited workers may leave locked cache entries,</span><br><span class="line">           </span><br><span class="line">* and although it may be safe to remove them completely,</span><br><span class="line">           </span><br><span class="line">* we prefer to just move them to the top of the inactive queue</span><br><span class="line">           </span><br><span class="line">*/</span><br><span class="line">  </span><br><span class="line">//将当前节点放入队列最前端</span><br><span class="line">          </span><br><span class="line">ngx_queue_remove(q);</span><br><span class="line">          </span><br><span class="line">fcn-&gt;expire = ngx_time() + cache-&gt;inactive;</span><br><span class="line">          </span><br><span class="line">ngx_queue_insert_head(&amp;cache-&gt;sh-&gt;queue, &amp;fcn-&gt;queue);</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">ngx_free(name);</span><br><span class="line"></span><br><span class="line">return wait;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是ngx_http_file_cache_forced_expire，顾名思义，就是强制删除cache 节点，它的返回值也是wait time。它的遍历也是从后到前的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static time_t</span><br><span class="line">  </span><br><span class="line">ngx_http_file_cache_forced_expire(ngx_http_file_cache_t *cache)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line"></span><br><span class="line">path = cache-&gt;path;</span><br><span class="line">      </span><br><span class="line">len = path-&gt;name.len + 1 + path-&gt;len + 2 * NGX_HTTP_CACHE_KEY_LEN;</span><br><span class="line"></span><br><span class="line">name = ngx_alloc(len + 1, ngx_cycle-&gt;log);</span><br><span class="line">      </span><br><span class="line">if (name == NULL) &#123;</span><br><span class="line">          </span><br><span class="line">return 10;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_memcpy(name, path-&gt;name.data, path-&gt;name.len);</span><br><span class="line"></span><br><span class="line">wait = 10;</span><br><span class="line">  </span><br><span class="line">//删除节点尝试次数</span><br><span class="line">      </span><br><span class="line">tries = 20;</span><br><span class="line"></span><br><span class="line">ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line">  </span><br><span class="line">//遍历队列</span><br><span class="line">      </span><br><span class="line">for (q = ngx_queue_last(&amp;cache-&gt;sh-&gt;queue);</span><br><span class="line">           </span><br><span class="line">q != ngx_queue_sentinel(&amp;cache-&gt;sh-&gt;queue);</span><br><span class="line">           </span><br><span class="line">q = ngx_queue_prev(q))</span><br><span class="line">      </span><br><span class="line">&#123;</span><br><span class="line">          </span><br><span class="line">fcn = ngx_queue_data(q, ngx_http_file_cache_node_t, queue);</span><br><span class="line"></span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line">  </span><br><span class="line">//如果引用计数为0则删除cache</span><br><span class="line">          </span><br><span class="line">if (fcn-&gt;count == 0) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_file_cache_delete(cache, q, name);</span><br><span class="line">              </span><br><span class="line">wait = 0;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//否则尝试20次</span><br><span class="line">              </span><br><span class="line">if (&amp;#8211;tries) &#123;</span><br><span class="line">                  </span><br><span class="line">continue;</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wait = 1;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">break;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">ngx_free(name);</span><br><span class="line"></span><br><span class="line">return wait;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的分析中还有一个函数就是ngx_http_file_cache_delete，这个函数这里就不分析了，它主要有2个功能，一个是删除cache文件，一个是删除cache管理节点。</p>
<p>然后来看loader的handle，ngx_http_file_cache_loader这个函数，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static void</span><br><span class="line">  </span><br><span class="line">ngx_http_file_cache_loader(void *data)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_http_file_cache_t *cache = data;</span><br><span class="line"></span><br><span class="line">ngx_tree_ctx_t tree;</span><br><span class="line"></span><br><span class="line">if (!cache-&gt;sh-&gt;cold || cache-&gt;sh-&gt;loading) &#123;</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!ngx_atomic_cmp_set(&amp;cache-&gt;sh-&gt;loading, 0, ngx_pid)) &#123;</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;.</span><br><span class="line">  </span><br><span class="line">//设置回调，后续会介绍这几个回调的含义</span><br><span class="line">      </span><br><span class="line">tree.init_handler = NULL;</span><br><span class="line">      </span><br><span class="line">tree.file_handler = ngx_http_file_cache_manage_file;</span><br><span class="line">      </span><br><span class="line">tree.pre_tree_handler = ngx_http_file_cache_noop;</span><br><span class="line">      </span><br><span class="line">tree.post_tree_handler = ngx_http_file_cache_noop;</span><br><span class="line">      </span><br><span class="line">tree.spec_handler = ngx_http_file_cache_delete_file;</span><br><span class="line">  </span><br><span class="line">//回调数据就是cache</span><br><span class="line">      </span><br><span class="line">tree.data = cache;</span><br><span class="line">      </span><br><span class="line">tree.alloc = 0;</span><br><span class="line">      </span><br><span class="line">tree.log = ngx_cycle-&gt;log;</span><br><span class="line">  </span><br><span class="line">//last为最后load时间</span><br><span class="line">      </span><br><span class="line">cache-&gt;last = ngx_current_msec;</span><br><span class="line">      </span><br><span class="line">cache-&gt;files = 0;</span><br><span class="line">  </span><br><span class="line">//开始遍历</span><br><span class="line">      </span><br><span class="line">if (ngx_walk_tree(&amp;tree, &amp;cache-&gt;path-&gt;name) == NGX_ABORT) &#123;</span><br><span class="line">          </span><br><span class="line">cache-&gt;sh-&gt;loading = 0;</span><br><span class="line">          </span><br><span class="line">return;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cache-&gt;sh-&gt;cold = 0;</span><br><span class="line">      </span><br><span class="line">cache-&gt;sh-&gt;loading = 0;</span><br><span class="line">  </span><br><span class="line">&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;&amp;#8230;..</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面有一个很核心的数据结构，就是ngx_tree_ctx_t，它的结构在nginx里面有注释，我们可以看下注释：</p>
<blockquote>
<ul>
<li>ctx-&gt;init_handler() &#8211; see ctx-&gt;alloc</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>ctx-&gt;file_handler() &#8211; file handler</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>ctx-&gt;pre_tree_handler() &#8211; handler is called before entering directory</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>ctx-&gt;post_tree_handler() &#8211; handler is called after leaving directory</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>ctx-&gt;spec_handler() &#8211; special (socket, FIFO, etc.) file handler</li>
</ul>
</blockquote>
<blockquote>
<p>*</p>
</blockquote>
<blockquote>
<ul>
<li>ctx-&gt;data &#8211; some data structure, it may be the same on all levels, or</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>reallocated if ctx-&gt;alloc is nonzero</li>
</ul>
</blockquote>
<blockquote>
<p>*</p>
</blockquote>
<blockquote>
<ul>
<li>ctx-&gt;alloc &#8211; a size of data structure that is allocated at every level</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>and is initilialized by ctx-&gt;init_handler()</li>
</ul>
</blockquote>
<blockquote>
<p>*</p>
</blockquote>
<blockquote>
<ul>
<li>ctx-&gt;log &#8211; a log </li>
</ul>
</blockquote>
<p>不过这里要注意在nginx的当前cache实现中，只有file_handler和spec_handler被设置了，其他的都是空，因此我们着重来看ngx_http_file_cache_manage_file，这里ngx_walk_tree就不分析了，这个函数主要是遍历所有的cache目录，然后对于每一个cache文件调用file_handler回调。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static ngx_int_t</span><br><span class="line">  </span><br><span class="line">ngx_http_file_cache_manage_file(ngx_tree_ctx_t \*ctx, ngx_str_t \*path)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_msec_t elapsed;</span><br><span class="line">      </span><br><span class="line">ngx_http_file_cache_t *cache;</span><br><span class="line"></span><br><span class="line">cache = ctx-&gt;data;</span><br><span class="line">  </span><br><span class="line">//将文件添加进cache</span><br><span class="line">      </span><br><span class="line">if (ngx_http_file_cache_add_file(ctx, path) != NGX_OK) &#123;</span><br><span class="line">          </span><br><span class="line">(void) ngx_http_file_cache_delete_file(ctx, path);</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//如果文件个数太大，则休眠并清理files计数</span><br><span class="line">      </span><br><span class="line">if (++cache-&gt;files &gt;= cache-&gt;loader_files) &#123;</span><br><span class="line">          </span><br><span class="line">ngx_http_file_cache_loader_sleep(cache);</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">          </span><br><span class="line">ngx_time_update();</span><br><span class="line">  </span><br><span class="line">//否则看loader时间是不是过长，如果过长则又进入休眠</span><br><span class="line">          </span><br><span class="line">elapsed = ngx_abs((ngx_msec_int_t) (ngx_current_msec &amp;#8211; cache-&gt;last));</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_HTTP, ngx_cycle-&gt;log, 0,</span><br><span class="line">                         </span><br><span class="line">&quot;http file cache loader time elapsed: %M&quot;, elapsed);</span><br><span class="line"></span><br><span class="line">if (elapsed &gt;= cache-&gt;loader_threshold) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_http_file_cache_loader_sleep(cache);</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return (ngx_quit || ngx_terminate) ? NGX_ABORT : NGX_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面有两个函数没有分析，分别是ngx_http_file_cache_add_file和ngx_http_file_cache_loader_sleep。其中sleep函数比较简单，就是休眠,并重置对应的域：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static void</span><br><span class="line">  </span><br><span class="line">ngx_http_file_cache_loader_sleep(ngx_http_file_cache_t *cache)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_msleep(cache-&gt;loader_sleep);</span><br><span class="line"></span><br><span class="line">ngx_time_update();</span><br><span class="line"></span><br><span class="line">cache-&gt;last = ngx_current_msec;</span><br><span class="line">      </span><br><span class="line">cache-&gt;files = 0;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后来看ngx_http_file_cache_add_file,它主要是通过文件名计算hash，然后调用ngx_http_file_cache_add将这个文件加入到cache管理中(也就是添加红黑树以及队列),因此我们就主要来看ngx_http_file_cache_add。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">static ngx_int_t</span><br><span class="line">  </span><br><span class="line">ngx_http_file_cache_add(ngx_http_file_cache_t \*cache, ngx_http_cache_t \*c)</span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">      </span><br><span class="line">ngx_http_file_cache_node_t *fcn;</span><br><span class="line"></span><br><span class="line">ngx_shmtx_lock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line">  </span><br><span class="line">//首先查找</span><br><span class="line">      </span><br><span class="line">fcn = ngx_http_file_cache_lookup(cache, c-&gt;key);</span><br><span class="line"></span><br><span class="line">if (fcn == NULL) &#123;</span><br><span class="line">  </span><br><span class="line">//如果不存在，则新建结构</span><br><span class="line">          </span><br><span class="line">fcn = ngx_slab_alloc_locked(cache-&gt;shpool,</span><br><span class="line">                                      </span><br><span class="line">sizeof(ngx_http_file_cache_node_t));</span><br><span class="line">          </span><br><span class="line">if (fcn == NULL) &#123;</span><br><span class="line">              </span><br><span class="line">ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line">              </span><br><span class="line">return NGX_ERROR;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_memcpy((u_char *) &amp;fcn-&gt;node.key, c-&gt;key, sizeof(ngx_rbtree_key_t));</span><br><span class="line"></span><br><span class="line">ngx_memcpy(fcn-&gt;key, &amp;c-&gt;key[sizeof(ngx_rbtree_key_t)],</span><br><span class="line">                     </span><br><span class="line">NGX_HTTP_CACHE_KEY_LEN &amp;#8211; sizeof(ngx_rbtree_key_t));</span><br><span class="line">  </span><br><span class="line">//插入红黑树</span><br><span class="line">          </span><br><span class="line">ngx_rbtree_insert(&amp;cache-&gt;sh-&gt;rbtree, &amp;fcn-&gt;node);</span><br><span class="line"></span><br><span class="line">fcn-&gt;uses = 1;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;count = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;valid_msec = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;error = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;exists = 1;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;updating = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;deleting = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;uniq = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;valid_sec = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;body_start = 0;</span><br><span class="line">          </span><br><span class="line">fcn-&gt;fs_size = c-&gt;fs_size;</span><br><span class="line"></span><br><span class="line">cache-&gt;sh-&gt;size += c-&gt;fs_size;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line">  </span><br><span class="line">//否则删除queue，后续会重新插入</span><br><span class="line">          </span><br><span class="line">ngx_queue_remove(&amp;fcn-&gt;queue);</span><br><span class="line">      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fcn-&gt;expire = ngx_time() + cache-&gt;inactive;</span><br><span class="line">  </span><br><span class="line">//重新插入</span><br><span class="line">      </span><br><span class="line">ngx_queue_insert_head(&amp;cache-&gt;sh-&gt;queue, &amp;fcn-&gt;queue);</span><br><span class="line"></span><br><span class="line">ngx_shmtx_unlock(&amp;cache-&gt;shpool-&gt;mutex);</span><br><span class="line"></span><br><span class="line">return NGX_OK;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一篇我将会介绍在upstream中如何使用cache的。</p>
</div><div class="tags"><a href="/tags/nginx/">nginx</a><a href="/tags/opensource/">opensource</a><a href="/tags/web-server/">web server</a></div><div class="post-nav"><a class="pre" href="/2012/04/08/hotwheels-source-code-analysis.html">hotwheels源码剖析</a><a class="next" href="/2012/03/04/c-reference-manual-reading-notes-five.html">c reference manual读书笔记(五)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/">SPDY</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/协议/">协议</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/server/">server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/lua/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/">server</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/源码阅读/">源码阅读</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/语言规范/">语言规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/rocksdb/" style="font-size: 15px;">rocksdb</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/server/" style="font-size: 15px;">server</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/aio/" style="font-size: 15px;">aio</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/process/" style="font-size: 15px;">process</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a> <a href="/tags/google/" style="font-size: 15px;">google</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/路由/" style="font-size: 15px;">路由</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TFO/" style="font-size: 15px;">TFO</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/语言规范/" style="font-size: 15px;">语言规范</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/spdy/" style="font-size: 15px;">spdy</a> <a href="/tags/kenel/" style="font-size: 15px;">kenel</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/InnoDB/" style="font-size: 15px;">InnoDB</a> <a href="/tags/sever/" style="font-size: 15px;">sever</a> <a href="/tags/rfs/" style="font-size: 15px;">rfs</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/congest/" style="font-size: 15px;">congest</a> <a href="/tags/server，mm/" style="font-size: 15px;">server，mm</a> <a href="/tags/web-server/" style="font-size: 15px;">web server</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/pipeline/" style="font-size: 15px;">pipeline</a> <a href="/tags/tcp-cork/" style="font-size: 15px;">tcp_cork</a> <a href="/tags/服务器设计/" style="font-size: 15px;">服务器设计</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/mochiweb/" style="font-size: 15px;">mochiweb</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/loadbalance/" style="font-size: 15px;">loadbalance</a> <a href="/tags/glibc/" style="font-size: 15px;">glibc</a> <a href="/tags/systemcall/" style="font-size: 15px;">systemcall</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/gro/" style="font-size: 15px;">gro</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/19/redo-log-design-and-implementation-in-innodb-1.html">InnoDB中Redo log设计与实现(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/mtr-minitransaction-design-and-implementation.html">MTR(mini-transaction)设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/design-and-implementation-of-linkbuf-in-innodb.html">InnoDB中LinkBuf设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/innodb-tablespace-source-code-analysis.html">InnoDB tablespace源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/mysql-·-rocksdb-data-reading-2.html">MySQL · RocksDB · 数据的读取(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/mysql-·-rocksdb-data-reading-1.html">MySQL · RocksDB · 数据的读取(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/mysql-·-rocksdb-level-compact-analysis.html">MySQL · RocksDB · Level Compact 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/07/mysql-·-rocksdb-memtable-flush-analysis.html">MySQL · RocksDB · Memtable flush分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/mysql-·-rocksdb-memtable-write.html">MySQL · RocksDB ·  MemTable的写入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/mysql-·-rocksdb-implementation-of-write-logic.html">MySQL · RocksDB ·  写入逻辑的实现</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">pagefault.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
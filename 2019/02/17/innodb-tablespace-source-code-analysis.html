<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>InnoDB tablespace源码分析 | pagefault</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">InnoDB tablespace源码分析</h1><a id="logo" href="/.">pagefault</a><p class="description">但行好事 莫問前程</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">InnoDB tablespace源码分析</h1><div class="post-meta">Feb 17, 2019</div><div class="post-content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>首先来看tablespace的定义：</p>
<blockquote>
<p>A data file that can hold data for one or more InnoDB tables and associated indexes.  </p>
</blockquote>
<p>这里system tablespace是一个特殊的tablespace,他包含了很多数据文件(ibdata files).而且如果没有设置 file-per-table的话，所有的新创建的表的数据以及索引信息都会保存在它里面.</p>
<p>下面就是ibdata可能包含的内容</p>
<blockquote>
<p>A set of files with names such as ibdata1, ibdata2, and so on, that make up the InnoDB system tablespace. These files contain metadata about InnoDB tables, (the InnoDB data dictionary), and the storage areas for one or more undo logs, the change buffer, and the doublewrite buffer.   </p>
</blockquote>
<p>假设设置了file-per-table(默认打开),那么每一个表都会有自己的tablespace文件(.ibd).</p>
<blockquote>
<p>The .ibd file extension does not apply to the system tablespace, which consists of one or more ibdata files.  </p>
</blockquote>
<p>还有一种就是temporary tablespace，也就是临时表的tablespace.</p>
<blockquote>
<p>InnoDB uses two types of temporary tablespace. Session temporary tablespaces store user-created temporary tables and internal temporary tables created by the optimizer.  </p>
</blockquote>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>通过上面我们可以简单的认为tablespace就是对于数据库中table的内部抽象.</p>
<p>既然我们已经知道tablespace是和table相关的，那么我们就按照这个逻辑来分析源码.</p>
<h3 id="shared-tablespace"><a href="#shared-tablespace" class="headerlink" title="shared tablespace"></a>shared tablespace</h3><p>首先来看system tablespace的创建，在InnoDB中每一个tablespace都会有一个uint32类型的id,每一个唯一的id用来表示对应的tablespace,而system tablespace的space id就是0.</p>
<p><code>static const space_id_t TRX_SYS_SPACE = 0;</code></p>
<p>而由于只有system tablespace和temporary tablespace是共享的，因此他们在InnoDB中有专门的数据结构来表示他们(Tablespace表示所有的shared tablespace的基类).</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SysTablespace</span> :</span> <span class="keyword">public</span> Tablespace &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  SysTablespace()</span><br><span class="line">      : m_auto_extend_last_file(),</span><br><span class="line">        m_last_file_size_max(),</span><br><span class="line">        m_created_new_raw(),</span><br><span class="line">        m_is_tablespace_full(<span class="literal">false</span>),</span><br><span class="line">        m_sanity_checks_done(<span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">/* No op */</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>而对应的变量则是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** The control info of the system tablespace. */</span></span><br><span class="line">SysTablespace srv_sys_space;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The control info of a temporary table shared tablespace. */</span></span><br><span class="line">SysTablespace srv_tmp_space;</span><br></pre></td></tr></table></figure>
<p>而tablespace数据文件的创建则是在SysTablespace::open_or_create中，因此我们来看这个函数.这个函数主要功能是遍历当前system tablespace的所有文件(m_files),然后存在就打开，不存在就创建对应的文件.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">files_t</span>::iterator begin = m_files.begin();</span><br><span class="line">  <span class="keyword">files_t</span>::iterator end = m_files.end();</span><br><span class="line"></span><br><span class="line">  ut_ad(begin-&gt;order() == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">files_t</span>::iterator it = begin; it != end; ++it) &#123;</span><br><span class="line">    <span class="keyword">if</span> (it-&gt;m_exists) &#123;</span><br><span class="line">      err = open_file(*it);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      err = create_file(*it);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>当打开文件之后，将会把打开的文件进行缓存，而InnoDB会将所有的tablespace缓存在fil_system中.这里要注意的是在将文件放入缓存之前会先关闭，因为最终所有的文件都是通过space(fil_space_t)对象来操作的.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Close the curent handles, add space and file info to the</span></span><br><span class="line"><span class="comment">  fil_system cache and the Data Dictionary, and re-open them</span></span><br><span class="line"><span class="comment">  in file_system cache so that they stay open until shutdown. */</span></span><br><span class="line">  ulint node_counter = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">files_t</span>::iterator it = begin; it != end; ++it) &#123;</span><br><span class="line">    it-&gt;close();</span><br><span class="line">    it-&gt;m_exists = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (it == begin) &#123;</span><br><span class="line">      <span class="comment">/* First data file. */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Create the tablespace entry for the multi-file</span></span><br><span class="line"><span class="comment">      tablespace in the tablespace manager. */</span></span><br><span class="line">      space =</span><br><span class="line">          fil_space_create(name(), space_id(), flags(),</span><br><span class="line">                           is_temp ? FIL_TYPE_TEMPORARY : FIL_TYPE_TABLESPACE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">page_no_t</span> max_size =</span><br><span class="line">        (++node_counter == m_files.size()</span><br><span class="line">             ? (m_last_file_size_max == <span class="number">0</span> ? PAGE_NO_MAX : m_last_file_size_max)</span><br><span class="line">             : it-&gt;m_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Add the datafile to the fil_system cache. */</span></span><br><span class="line">    <span class="keyword">if</span> (!fil_node_create(it-&gt;m_filepath, it-&gt;m_size, space,</span><br><span class="line">                         it-&gt;m_type != SRV_NOT_RAW, it-&gt;m_atomic_write,</span><br><span class="line">                         max_size)) &#123;</span><br><span class="line">      err = DB_ERROR;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中有两个关键调用第一个就是fil_space_create,可以看到遍历文件一开始就创建space,这里后续所有对于space的操作都是通过fil_space_t来进行的. 而这里我们可以看到对于sys_space和redo_space都是有全局变量来操作的.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fil_space_t</span> *fil_space_create(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">space_id_t</span> space_id,</span><br><span class="line">                              ulint flags, <span class="keyword">fil_type_t</span> purpose) &#123;</span><br><span class="line">.....................................</span><br><span class="line">  fil_system-&gt;mutex_acquire_all();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> shard = fil_system-&gt;shard_by_id(space_id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> space = shard-&gt;space_create(name, space_id, flags, purpose);</span><br><span class="line">...........................................</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Cache the system tablespaces, avoid looking them up during IO. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (space-&gt;id == TRX_SYS_SPACE) &#123;</span><br><span class="line">    ut_a(<span class="keyword">fil_space_t</span>::s_sys_space == <span class="literal">nullptr</span> ||</span><br><span class="line">         <span class="keyword">fil_space_t</span>::s_sys_space == space);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fil_space_t</span>::s_sys_space = space;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (space-&gt;id == <span class="keyword">dict_sys_t</span>::s_log_space_first_id) &#123;</span><br><span class="line">    ut_a(<span class="keyword">fil_space_t</span>::s_redo_space == <span class="literal">nullptr</span> ||</span><br><span class="line">         <span class="keyword">fil_space_t</span>::s_redo_space == space);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fil_space_t</span>::s_redo_space = space;</span><br><span class="line">  &#125;</span><br><span class="line">.............................</span><br><span class="line">  <span class="keyword">return</span> (space);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而fil_node_create就是将当前的文件加入到创建好的space中并且缓存，在InnoDB中所有的数据文件都会统一管理，其中redo/undo会做特殊处理，而其他的tablespace则会根据他们的spaceid进行缓存.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">fil_node_create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">page_no_t</span> size, <span class="keyword">fil_space_t</span> *space,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">bool</span> is_raw, <span class="keyword">bool</span> atomic_write, <span class="keyword">page_no_t</span> max_pages)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> shard = fil_system-&gt;shard_by_id(space-&gt;id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">fil_node_t</span> *file;</span><br><span class="line"></span><br><span class="line">  file = shard-&gt;create_node(name, size, space, is_raw,</span><br><span class="line">                            IORequest::is_punch_hole_supported(), atomic_write,</span><br><span class="line">                            max_pages);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (file == <span class="literal">nullptr</span> ? <span class="literal">nullptr</span> : file-&gt;name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时的疑问就是m_files是何时被初始化的，也就是system tablespace文件的初始化，这里system tablespace的文件初始化是在数据库init的时候被初始化的，因此我们来看相关代码 .</p>
<p>InnoDB中有一个变量叫做innobase_data_file_path，这个变量是一个字符串，这个字符串包含了所有的system tablespace需要创建 的文件以及一些属性，这个字符串默认值是在InnoDB引擎初始化的时候初始化的.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Set default InnoDB temp data file size to 12 MB and let it be</span></span><br><span class="line"><span class="comment">auto-extending. */</span></span><br><span class="line"><span class="keyword">if</span> (!innobase_data_file_path) &#123;</span><br><span class="line">  innobase_data_file_path = (<span class="keyword">char</span> *)<span class="string">"ibdata1:12M:autoextend"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到默认只创建ibdata1文件，并且大小为12m,自动扩展，而innobase_data_file_path的格式如下</p>
<blockquote>
<p>innodb_data_file_path=datafile_spec1[;datafile_spec2]..<br>file_name:file_size[:autoextend[:max:max_file_size]]  </p>
</blockquote>
<p>因此system tablespace创建文件也会根据这个配置来创建，也就是当InnoDB参数解析完毕之后进入system tablespace的文件创建.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">int</span> error = innodb_init_params()) &#123;</span><br><span class="line">  DBUG_RETURN(error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* After this point, error handling has to use</span></span><br><span class="line"><span class="comment">innodb_init_abort(). */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!srv_sys_space.parse_params(innobase_data_file_path, <span class="literal">true</span>)) &#123;</span><br><span class="line">  ib::error(ER_IB_MSG_545)</span><br><span class="line">      &lt;&lt; <span class="string">"Unable to parse innodb_data_file_path="</span> &lt;&lt; innobase_data_file_path;</span><br><span class="line">  DBUG_RETURN(innodb_init_abort());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>parse_params这个函数将会解析innobase_data_file_path,然后根据不同的属性创建对应的文件，先来看参数解析.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*---------------------- PASS 1 ---------------------------*/</span></span><br><span class="line">  <span class="comment">/* First calculate the number of data files and check syntax. */</span></span><br><span class="line">  <span class="keyword">while</span> (*ptr != <span class="string">'\0'</span>) &#123;</span><br><span class="line">    filepath = ptr;</span><br><span class="line"></span><br><span class="line">    ptr = parse_file_name(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ptr == filepath) &#123;</span><br><span class="line">...........................</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*ptr == <span class="string">'\0'</span>) &#123;</span><br><span class="line">.................................</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ptr++;</span><br><span class="line"></span><br><span class="line">    size = parse_units(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">.........................</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">":autoextend"</span>, (<span class="keyword">sizeof</span> <span class="string">":autoextend"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">      ptr += (<span class="keyword">sizeof</span> <span class="string">":autoextend"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">":max:"</span>, (<span class="keyword">sizeof</span> <span class="string">":max:"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">        ptr += (<span class="keyword">sizeof</span> <span class="string">":max:"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">page_no_t</span> max = parse_units(ptr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (max &lt; size) &#123;</span><br><span class="line">          <span class="keyword">goto</span> invalid_size;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (*ptr == <span class="string">';'</span>) &#123;</span><br><span class="line">..................................</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">"new"</span>, (<span class="keyword">sizeof</span> <span class="string">"new"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">      ptr += (<span class="keyword">sizeof</span> <span class="string">"new"</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">"raw"</span>, (<span class="keyword">sizeof</span> <span class="string">"raw"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">...............................</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ptr += (<span class="keyword">sizeof</span> <span class="string">"raw"</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ++n_files;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*ptr == <span class="string">';'</span>) &#123;</span><br><span class="line">      ptr++;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*ptr != <span class="string">'\0'</span>) &#123;</span><br><span class="line">.......................</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n_files == <span class="number">0</span>) &#123;</span><br><span class="line">......................</span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后第二步就是存储对应的文件名以及属性到m_files中，这里有一个重要的数据结构就是Datafile,每一个数据文件在InnoDB中的抽象就是Datafile.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (*ptr != <span class="string">'\0'</span>) &#123;</span><br><span class="line">    filepath = ptr;</span><br><span class="line"></span><br><span class="line">    ptr = parse_file_name(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*ptr == <span class="string">':'</span>) &#123;</span><br><span class="line">      <span class="comment">/* Make filepath a null-terminated string */</span></span><br><span class="line">      *ptr = <span class="string">'\0'</span>;</span><br><span class="line">      ptr++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = parse_units(ptr);</span><br><span class="line">    ut_ad(size &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">":autoextend"</span>, (<span class="keyword">sizeof</span> <span class="string">":autoextend"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">      m_auto_extend_last_file = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      ptr += (<span class="keyword">sizeof</span> <span class="string">":autoextend"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">":max:"</span>, (<span class="keyword">sizeof</span> <span class="string">":max:"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">        ptr += (<span class="keyword">sizeof</span> <span class="string">":max:"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        m_last_file_size_max = parse_units(ptr);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_files.push_back(Datafile(filepath, flags(), size, order));</span><br><span class="line">    Datafile *datafile = &amp;m_files.back();</span><br><span class="line">    datafile-&gt;make_filepath(path(), filepath, NO_EXT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">"new"</span>, (<span class="keyword">sizeof</span> <span class="string">"new"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">      ptr += (<span class="keyword">sizeof</span> <span class="string">"new"</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(ptr, <span class="string">"raw"</span>, (<span class="keyword">sizeof</span> <span class="string">"raw"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">      ut_a(supports_raw);</span><br><span class="line"></span><br><span class="line">      ptr += (<span class="keyword">sizeof</span> <span class="string">"raw"</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Initialize new raw device only during initialize */</span></span><br><span class="line">      m_files.back().m_type =</span><br><span class="line">#ifndef UNIV_HOTBACKUP</span><br><span class="line">          opt_initialize ? SRV_NEW_RAW : SRV_OLD_RAW;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>  <span class="comment">/* !UNIV_HOTBACKUP */</span></span></span><br><span class="line">          SRV_OLD_RAW;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !UNIV_HOTBACKUP */</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*ptr == <span class="string">';'</span>) &#123;</span><br><span class="line">      ++ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    order++;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="非shared-tablespace"><a href="#非shared-tablespace" class="headerlink" title="非shared tablespace"></a>非shared tablespace</h3><p>然后我们来看一般的tablespace的创建,一般来说每创建一个表都会创建一个新的ibd文件，也就是tablespace. 而这种tablespace以及Redolog/undolog都是属于fil_space_t这个结构体.通过上面的代码我们知道system tablespace最终也是创建一个fil_space_t然后再接入整个系统的tablespace的管理的.</p>
<p>这里先来看两个特殊的tablespace,也就是REDO log和UNDO log，由于这两个log也都是磁盘上的文件，因此在InnoDB中会讲这两个log文件作为一种特殊的tablespace，来看他们的初始化.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> dberr_t <span class="title">create_log_files</span><span class="params">(<span class="keyword">char</span> *logfilename, <span class="keyword">size_t</span> dirnamelen, <span class="keyword">lsn_t</span> lsn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">char</span> *&amp;logfile0, <span class="keyword">lsn_t</span> &amp;checkpoint_lsn)</span> </span>&#123;</span><br><span class="line">........................</span><br><span class="line">    <span class="comment">/* Disable the doublewrite buffer for log files. */</span></span><br><span class="line">    <span class="keyword">fil_space_t</span> *log_space = fil_space_create(</span><br><span class="line">        <span class="string">"innodb_redo_log"</span>, <span class="keyword">dict_sys_t</span>::s_log_space_first_id,</span><br><span class="line">        fsp_flags_set_page_size(<span class="number">0</span>, univ_page_size), FIL_TYPE_LOG);</span><br><span class="line">.......................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面的undo log.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> dberr_t <span class="title">srv_undo_tablespace_open</span><span class="params">(<span class="keyword">space_id_t</span> space_id)</span> </span>&#123;</span><br><span class="line">....................................</span><br><span class="line">    space = fil_space_create(undo_name, space_id, flags, FIL_TYPE_TABLESPACE);</span><br><span class="line">..............</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以后我们详细分析undolog/redolog的时候会再来分析这个地方</p>
<p>接下来我们就来看当一般表的创建的时候会发生什么，对于一般的表，创建tablespace是跟随着ibd文件一起创建的(上面的都是在初始化的时候创建)。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">dd_create_hardcoded</span><span class="params">(<span class="keyword">space_id_t</span> space_id, <span class="keyword">const</span> <span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">page_no_t</span> pages = FIL_IBD_FILE_INITIAL_SIZE;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">dberr_t</span> err = fil_ibd_create(space_id, <span class="keyword">dict_sys_t</span>::s_dd_space_name, filename,</span><br><span class="line">                               predefined_flags, pages);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err == DB_SUCCESS) &#123;</span><br><span class="line">    <span class="keyword">mtr_t</span> mtr;</span><br><span class="line">    mtr.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> ret = fsp_header_init(space_id, pages, &amp;mtr, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    mtr.commit();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">      btr_sdi_create_index(space_id, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Tablespace-pool"><a href="#Tablespace-pool" class="headerlink" title="Tablespace pool"></a>Tablespace pool</h3><p>在MySQL 8.0中，由于临时表也全部使用了InnoDB,因此创建代价会比5.6(myisam)大，所以在8.0中session临时表会有一个pool来控制，在启动的时候会创建这个pool。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err = ibt::open_or_create(create_new_db);</span><br><span class="line"><span class="keyword">if</span> (err != DB_SUCCESS) &#123;</span><br><span class="line">  <span class="keyword">return</span> (srv_init_abort(err));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在open_or_create函数中会先创建对应的临时表的目录，然后再创建对应的pool,最后初始化pool.</p>
<ul>
<li>这里初始的tablespace pool的大小是10(INIT_SIZE)</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dberr_t</span> open_or_create(<span class="keyword">bool</span> create_new_db) &#123;</span><br><span class="line">  <span class="keyword">dberr_t</span> err = create_temp_dir();</span><br><span class="line">  <span class="keyword">if</span> (err != DB_SUCCESS) &#123;</span><br><span class="line">    <span class="keyword">return</span> (err);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tbsp_pool = UT_NEW_NOKEY(Tablespace_pool(INIT_SIZE));</span><br><span class="line">  <span class="keyword">if</span> (tbsp_pool == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (DB_OUT_OF_MEMORY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  err = tbsp_pool-&gt;initialize(create_new_db);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Tablespace pool的实现比较粗糙,它包含了两个链表，一个保存已经使用的tablespace,一个保存了还未使用的tablespace.</p>
<p>下面我们来看下Tablespace_pool这个类的字段.</p>
<ul>
<li>m_free和m_active分别保存了未使用和已使用的.</li>
<li>m_mutex用来保证并发的存取pool</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tablespace_pool</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> Pool = <span class="built_in">std</span>::<span class="built_in">list</span>&lt;Tablespace *, ut_allocator&lt;Tablespace *&gt;&gt;;</span><br><span class="line">............................</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  *<span class="comment">/** True after the pool has been initialized */</span>*</span><br><span class="line">  <span class="keyword">bool</span> m_pool_initialized;</span><br><span class="line">  *<span class="comment">/** Initial size of pool */</span>*</span><br><span class="line">  <span class="keyword">size_t</span> m_init_size;</span><br><span class="line">  *<span class="comment">/** Vector of tablespaces that are unused */</span>*</span><br><span class="line">  Pool *m_free;</span><br><span class="line">  *<span class="comment">/** Vector of tablespaces that are being used */</span>*</span><br><span class="line">  Pool *m_active;</span><br><span class="line">  *<span class="comment">/** Mutex to protect concurrent operations on the pool */</span>*</span><br><span class="line">  <span class="keyword">ib_mutex_t</span> m_mutex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来我们来看tablespace_pool的初始化.</p>
<ul>
<li>初始化m_active和m_free两个链表</li>
<li>调用expand来扩展pool.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dberr_t</span> Tablespace_pool::initialize(<span class="keyword">bool</span> create_new_db) &#123;</span><br><span class="line">  <span class="keyword">if</span> (m_pool_initialized) &#123;</span><br><span class="line">    <span class="keyword">return</span> (DB_SUCCESS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ut_ad(m_active == <span class="literal">nullptr</span> &amp;&amp; m_free == <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  m_active = UT_NEW_NOKEY(Pool());</span><br><span class="line">  <span class="keyword">if</span> (m_active == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (DB_OUT_OF_MEMORY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  m_free = UT_NEW_NOKEY(Pool());</span><br><span class="line">  <span class="keyword">if</span> (m_free == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (DB_OUT_OF_MEMORY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  delete_old_pool(create_new_db);</span><br><span class="line">  <span class="keyword">dberr_t</span> err = expand(m_init_size);</span><br><span class="line">  <span class="keyword">if</span> (err != DB_SUCCESS) &#123;</span><br><span class="line">    <span class="keyword">return</span> (err);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  m_pool_initialized = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> (DB_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话，所有的初始化其实都在expand中进行.</p>
<ul>
<li>创建Tablespace对象(非shared的tablespace)</li>
<li>加入到m_free链表中.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dberr_t</span> Tablespace_pool::expand(<span class="keyword">size_t</span> size) &#123;</span><br><span class="line">  ut_ad(!m_pool_initialized || mutex_own(&amp;m_mutex));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">    Tablespace *ts = UT_NEW_NOKEY(Tablespace());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ts == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (DB_OUT_OF_MEMORY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">dberr_t</span> err = ts-&gt;create();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == DB_SUCCESS) &#123;</span><br><span class="line">      m_free-&gt;push_back(ts);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      UT_DELETE(ts);</span><br><span class="line">      <span class="keyword">return</span> (err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (DB_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后我们来看tablespace_pool的读取以及删除方法.首先来看get</p>
<ul>
<li>如果m_free为空，也就是pool中的所有的tablespace都已经被使用了，此时InnoDB会再次扩展这个pool.而再次扩展的大小也是10(POOL_EXPAND_SIZE)</li>
<li>每次进来都会使用mutex锁来控制</li>
<li>使用很简单就是从m_free中得到一个ts,然后再将这个ts加入到m_active中.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Tablespace *Tablespace_pool::get(my_thread_id id, <span class="keyword">enum</span> tbsp_purpose purpose) &#123;</span><br><span class="line">  DBUG_EXECUTE_IF(<span class="string">"ibt_pool_exhausted"</span>, <span class="keyword">return</span> (<span class="literal">nullptr</span>););</span><br><span class="line"></span><br><span class="line">  Tablespace *ts = <span class="literal">nullptr</span>;</span><br><span class="line">  acquire();</span><br><span class="line">  <span class="keyword">if</span> (m_free-&gt;size() == <span class="number">0</span>) &#123;</span><br><span class="line">    *<span class="comment">/* Free pool is empty. Add more tablespaces by expanding it */</span>*</span><br><span class="line">    <span class="keyword">dberr_t</span> err = expand(POOL_EXPAND_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (err != DB_SUCCESS) &#123;</span><br><span class="line">      *<span class="comment">/* Failure to expand the pool means that there is no disk space*</span></span><br><span class="line"><span class="comment">*available to create .IBT files */</span>*</span><br><span class="line">      release();</span><br><span class="line">      ib::error() &lt;&lt; <span class="string">"Unable to expand the temporary tablespace pool"</span>;</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ts = m_free-&gt;back();</span><br><span class="line">  m_free-&gt;pop_back();</span><br><span class="line">  m_active-&gt;push_back(ts);</span><br><span class="line">  ts-&gt;set_thread_id_and_purpose(id, purpose);</span><br><span class="line"></span><br><span class="line">  release();</span><br><span class="line">  <span class="keyword">return</span> (ts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后就是释放使用过的tablespace到pool中.</p>
<ul>
<li>可以看到所有文件都是由fil_space管理</li>
<li>从m_active中遍历然后查找出对应的ts<ul>
<li>线性查找，可以看到如果临时表如果同时创建很多的话，这里性能会很成问题</li>
</ul>
</li>
<li>如果查找到则从m_active中删除，最后加入到m_free中.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Tablespace_pool::free_ts(Tablespace *ts) &#123;</span><br><span class="line">  <span class="keyword">space_id_t</span> space_id = ts-&gt;space_id();</span><br><span class="line">  <span class="keyword">fil_space_t</span> *space = fil_space_get(space_id);</span><br><span class="line">  ut_ad(space != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (space-&gt;size != FIL_IBT_FILE_INITIAL_SIZE) &#123;</span><br><span class="line">    ts-&gt;truncate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  acquire();</span><br><span class="line"></span><br><span class="line">  Pool::iterator it = <span class="built_in">std</span>::find(m_active-&gt;begin(), m_active-&gt;end(), ts);</span><br><span class="line">  <span class="keyword">if</span> (it != m_active-&gt;end()) &#123;</span><br><span class="line">    m_active-&gt;erase(it);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ut_ad(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  m_free-&gt;push_back(ts);</span><br><span class="line"></span><br><span class="line">  release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#MySQL/InnoDB/tablespace</p>
</div><div class="tags"><a href="/tags/InnoDB/">InnoDB</a></div><div class="post-nav"><a class="pre" href="/2019/04/17/.html">InnoDB中LinkBuf设计与实现</a><a class="next" href="/2018/12/19/mysql-rocksdb.-data-reading-(ii).html">MySQL · RocksDB · 数据的读取(二)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/">SPDY</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SPDY/协议/">协议</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/server/">server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/lua/源码阅读/">源码阅读</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/">server</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/server/源码阅读/">源码阅读</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/语言规范/">语言规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/rocksdb/" style="font-size: 15px;">rocksdb</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/server/" style="font-size: 15px;">server</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/aio/" style="font-size: 15px;">aio</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/process/" style="font-size: 15px;">process</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a> <a href="/tags/google/" style="font-size: 15px;">google</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/路由/" style="font-size: 15px;">路由</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TFO/" style="font-size: 15px;">TFO</a> <a href="/tags/rfc/" style="font-size: 15px;">rfc</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/语言规范/" style="font-size: 15px;">语言规范</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/spdy/" style="font-size: 15px;">spdy</a> <a href="/tags/kenel/" style="font-size: 15px;">kenel</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/InnoDB/" style="font-size: 15px;">InnoDB</a> <a href="/tags/sever/" style="font-size: 15px;">sever</a> <a href="/tags/rfs/" style="font-size: 15px;">rfs</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/congest/" style="font-size: 15px;">congest</a> <a href="/tags/server，mm/" style="font-size: 15px;">server，mm</a> <a href="/tags/web-server/" style="font-size: 15px;">web server</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/pipeline/" style="font-size: 15px;">pipeline</a> <a href="/tags/tcp-cork/" style="font-size: 15px;">tcp_cork</a> <a href="/tags/服务器设计/" style="font-size: 15px;">服务器设计</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/mochiweb/" style="font-size: 15px;">mochiweb</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/loadbalance/" style="font-size: 15px;">loadbalance</a> <a href="/tags/glibc/" style="font-size: 15px;">glibc</a> <a href="/tags/systemcall/" style="font-size: 15px;">systemcall</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/gro/" style="font-size: 15px;">gro</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/.html">MTR(mini-transaction)设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/.html">InnoDB中LinkBuf设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/innodb-tablespace-source-code-analysis.html">InnoDB tablespace源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/mysql-rocksdb.-data-reading-(ii).html">MySQL · RocksDB · 数据的读取(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/.html">MySQL · RocksDB · 数据的读取(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/.html">MySQL · RocksDB · Level Compact 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/07/.html">MySQL · RocksDB · Memtable flush分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/.html">MySQL · RocksDB ·  MemTable的写入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/implementation-of-mysql-rocksdb-writing-logic.html">MySQL · RocksDB ·  写入逻辑的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/06/.html">MySQL · RocksDB · Column Family介绍</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">pagefault.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>